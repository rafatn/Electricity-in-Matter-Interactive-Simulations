<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>מודל "רכבת-מטבולית" — גרסה משודרגת (v3)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --good:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow:0 10px 28px rgba(0,0,0,.08); --r:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text);}
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(246,247,251,.9); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    h1{margin:0; font-size:20px; line-height:1.2}
    .sub{color:var(--muted); font-size:13px; margin-top:4px}
    .pill{
      display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap;
      border:1px solid var(--line); background:#fff; padding:10px 12px;
      border-radius:999px; box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    select, button, input[type="range"], input[type="number"]{font:inherit}
    button{
      border:1px solid var(--line); background:#fff; padding:9px 12px;
      border-radius:12px; cursor:pointer; transition:.15s transform, .15s background;
    }
    button:hover{background:#fafafa}
    button:active{transform:scale(.98)}
    .btn-primary{
      border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.10);
      color:#0b2e8f; font-weight:900;
    }
    .btn-soft{
      border-color:rgba(22,163,74,.22); background:rgba(22,163,74,.10);
      color:#0b5b29; font-weight:850;
    }
    .btn-warn{
      border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.12);
      color:#7a4b00; font-weight:850;
    }
    .btn-danger{
      border-color:rgba(220,38,38,.25); background:rgba(220,38,38,.10);
      color:#7a0d0d; font-weight:850;
    }
    .btn-ghost{background:transparent}
    main{padding:18px 0 44px;}
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); padding:16px;
    }
    .card h2{margin:0 0 10px 0; font-size:18px}
    .card h3{margin:14px 0 8px 0; font-size:15px}
    p{margin:8px 0; line-height:1.65}
    .muted{color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:14px 0}
    .kbd{
      font-family:var(--mono); background:#0b1220; color:#e5e7eb;
      border-radius:12px; padding:12px; overflow:auto; font-size:13px; line-height:1.6;
      border:1px solid rgba(255,255,255,.06); white-space:pre-wrap;
    }
    .note{border:1px dashed rgba(37,99,235,.35); background:rgba(37,99,235,.06); border-radius:12px; padding:12px;}
    .warn{border:1px dashed rgba(245,158,11,.45); background:rgba(245,158,11,.08); border-radius:12px; padding:12px;}
    .ok{border:1px dashed rgba(22,163,74,.35); background:rgba(22,163,74,.06); border-radius:12px; padding:12px;}
    .scenarioBar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px;
      box-shadow:0 2px 12px rgba(0,0,0,.05);
      margin:10px 0 0 0;
    }
    .scenarioBtns{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .scenarioHint{color:var(--muted); font-size:12px; line-height:1.5}
    .rightTools{display:flex; gap:8px; flex-wrap:wrap}
    .controls{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    @media (max-width: 640px){ .controls{grid-template-columns:1fr;} }
    .ctl{border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff;}
    .ctl label{display:flex; justify-content:space-between; gap:10px; font-size:13px; color:#111827; font-weight:800}
    .ctl .v{color:var(--muted); font-weight:650}
    .ctl .row2{display:flex; gap:8px; align-items:center; margin-top:6px}
    input[type="range"]{width:100%}
    input[type="number"]{
      width:96px; padding:8px 10px; border:1px solid var(--line);
      border-radius:10px; background:#fff;
    }
    canvas{width:100%; height:220px; border:1px solid var(--line); border-radius:12px; background:#fff}
    details{border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff;}
    details summary{cursor:pointer; font-weight:900}
    .svgBox{border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px; overflow:auto}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--line); background:#fff}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:right; font-size:13px}
    th{background:#111827; color:#fff; font-weight:900}
    tr:last-child td{border-bottom:none}
    .mini{font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>מודל “רכבת-מטבולית” — v3</h1>
        <div class="sub">תסריטים מוכנים · גרף גלוקוז + גרף אינסולין · עומס תחנות · ייצוא CSV · עובד אופליין</div>
      </div>
      <div class="pill">
        <button class="btn-primary" id="btnDownload">⬇️ הורדת הקובץ (HTML)</button>
        <button class="btn-ghost" id="btnExportCSV">⬇️ ייצוא נתונים (CSV)</button>
        <select id="mode">
          <option value="normal">מצב רגיל</option>
          <option value="study">מצב לימוד</option>
          <option value="compact">מצב קומפקטי</option>
        </select>
      </div>
    </div>

    <div class="scenarioBar">
      <div>
        <div style="font-weight:950; margin-bottom:6px">תסריטים מוכנים</div>
        <div class="scenarioBtns">
          <button class="btn-soft" id="scHealthy">בריא</button>
          <button class="btn-warn" id="scResistance">עמידות לאינסולין</button>
          <button class="btn-danger" id="scT1">סוג 1 (אינסולין נמוך)</button>
          <button class="btn-primary" id="scSport">אחרי ספורט</button>
          <button id="scBigMeal">ארוחה גדולה</button>
        </div>
      </div>
      <div class="scenarioHint">
        בחר תסריט → לחץ “הרץ סימולציה”.<br/>
        אפשר לשנות ידנית כל פרמטר ואז להריץ שוב.
      </div>
      <div class="rightTools">
        <button id="runTop" class="btn-primary">▶︎ הרץ סימולציה</button>
        <button id="resetTop">↩︎ איפוס</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">
    <section class="card">
      <h2>הסבר קצר</h2>
      <div class="warn">
        <b>דיוק חשוב:</b> הטחול אינו מאזן סוכר. הלבלב (אינסולין/גלוקגון), הכבד (מחסן/שחרור/ייצור), והכליות (סף/קיבולת ספיגה) הם השחקנים המרכזיים באיזון גלוקוז.
      </div>

      <p>
        “רכבת מטבולית” = רשת זרימות ובקרות:
        הדם הוא המסילות, הלב הוא המשאבה, הלבלב/כבד הם מגדל הפיקוח,
        וכל איבר הוא “תחנה” שמקבלת אותות ומחליטה על קליטה/שחרור.
      </p>

      <div class="svgBox">
        <svg viewBox="0 0 980 320" width="980" height="320" role="img" aria-label="תרשים זרימה">
          <defs>
            <filter id="sh" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#000" flood-opacity=".15"/>
            </filter>
            <marker id="arr" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
              <path d="M0,0 L10,5 L0,10 z" fill="#2563eb"></path>
            </marker>
          </defs>

          <rect x="20" y="18" width="280" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="160" y="50" text-anchor="middle" font-size="16" font-weight="700" fill="#111827">הלבלב</text>
          <text x="160" y="76" text-anchor="middle" font-size="13" fill="#6b7280">מייצר יעד אינסולין</text>
          <text x="160" y="98" text-anchor="middle" font-size="13" fill="#6b7280">I(t) עם דיליי</text>

          <rect x="350" y="18" width="280" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="490" y="50" text-anchor="middle" font-size="16" font-weight="700" fill="#111827">הכבד</text>
          <text x="490" y="76" text-anchor="middle" font-size="13" fill="#6b7280">מחסן מוגבל</text>
          <text x="490" y="98" text-anchor="middle" font-size="13" fill="#6b7280">שחרור/אגירה</text>

          <rect x="680" y="18" width="280" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="820" y="50" text-anchor="middle" font-size="16" font-weight="700" fill="#111827">הדם</text>
          <text x="820" y="76" text-anchor="middle" font-size="13" fill="#6b7280">מסילות + מטען</text>
          <text x="820" y="98" text-anchor="middle" font-size="13" fill="#6b7280">G(t)</text>

          <line x1="300" y1="73" x2="350" y2="73" stroke="#2563eb" stroke-width="3" marker-end="url(#arr)"/>
          <line x1="630" y1="73" x2="680" y2="73" stroke="#2563eb" stroke-width="3" marker-end="url(#arr)"/>

          <rect x="80" y="175" width="190" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="175" y="205" text-anchor="middle" font-size="15" font-weight="700" fill="#111827">שריר</text>
          <text x="175" y="230" text-anchor="middle" font-size="12" fill="#6b7280">קליטה רוויה</text>
          <text x="175" y="252" text-anchor="middle" font-size="12" fill="#6b7280">+ Demand (ספורט)</text>

          <rect x="290" y="175" width="190" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="385" y="205" text-anchor="middle" font-size="15" font-weight="700" fill="#111827">שומן</text>
          <text x="385" y="230" text-anchor="middle" font-size="12" fill="#6b7280">קליטה רוויה</text>
          <text x="385" y="252" text-anchor="middle" font-size="12" fill="#6b7280">תלויה I,S</text>

          <rect x="500" y="175" width="190" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="595" y="205" text-anchor="middle" font-size="15" font-weight="700" fill="#111827">מוח</text>
          <text x="595" y="230" text-anchor="middle" font-size="12" fill="#6b7280">קליטה כמעט קבועה</text>

          <rect x="710" y="175" width="190" height="110" rx="16" fill="#fff" stroke="#e5e7eb" filter="url(#sh)"/>
          <text x="805" y="205" text-anchor="middle" font-size="15" font-weight="700" fill="#111827">כליה</text>
          <text x="805" y="230" text-anchor="middle" font-size="12" fill="#6b7280">Thr + Tm</text>
          <text x="805" y="252" text-anchor="middle" font-size="12" fill="#6b7280">איבוד לאחר קיבולת</text>

          <line x1="820" y1="128" x2="175" y2="175" stroke="#2563eb" stroke-width="2" marker-end="url(#arr)" opacity=".5"/>
          <line x1="820" y1="128" x2="385" y2="175" stroke="#2563eb" stroke-width="2" marker-end="url(#arr)" opacity=".5"/>
          <line x1="820" y1="128" x2="595" y2="175" stroke="#2563eb" stroke-width="2" marker-end="url(#arr)" opacity=".5"/>
          <line x1="820" y1="128" x2="805" y2="175" stroke="#2563eb" stroke-width="2" marker-end="url(#arr)" opacity=".5"/>
        </svg>
      </div>

      <div class="hr"></div>

      <h2>משוואות הדמו (בקיצור)</h2>
      <div class="kbd" id="eqBlock">
dG/dt = P_gut(t) + R_liver(G,I,L) - (U_muscle + U_fat + U_brain) - E_kidney(G)

I_target = i0 + 1.2 * sigmoid((G - Gset)/10)
dI/dt    = (I_target - I)/tauI

U_muscle = VmaxM * gateI(S,I) * gateG(G) * Demand
U_fat    = VmaxF * gateI(S,I) * gateG(G)
U_brain  = Vbrain * G/(Kbrain + G)

E_kidney = 0.020 * max(0, (G - Thr) - Tm)

L (מחסן כבד) מוגבל [0..Lmax] ומשפיע על שחרור הכבד
      </div>

      <details style="margin-top:12px">
        <summary>מה חדש לעומת הגרסה הקודמת?</summary>
        <div class="muted" style="margin-top:10px; line-height:1.7">
          1) כפתור ייצוא CSV (זמן, G, I, וזרימות).<br/>
          2) יותר יציבות במספרים, ונתונים נשמרים להרצה האחרונה.<br/>
          3) הורדת קובץ “עצמי” עדיין קיימת (אם תפתח את ה-HTML בדפדפן, הכפתור ייצור הורדה מקומית).
        </div>
      </details>
    </section>

    <aside class="card">
      <h2>סימולציה</h2>

      <h3 style="margin-top:6px">G(t) גלוקוז</h3>
      <canvas id="plotG" width="980" height="520"></canvas>

      <h3>I(t) אינסולין</h3>
      <canvas id="plotI" width="980" height="420"></canvas>

      <div class="controls">
        <div class="ctl">
          <label>ארוחה (A) <span class="v" id="vMeal">80</span></label>
          <input type="range" min="0" max="240" value="80" step="1" id="meal"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="mealN" min="0" max="240" step="1" value="80"/></div>
          <div class="muted mini">עוצמת “גל” מהמעי</div>
        </div>

        <div class="ctl">
          <label>רגישות לאינסולין (S) <span class="v" id="vSens">0.70</span></label>
          <input type="range" min="0" max="1" value="0.70" step="0.01" id="sens"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="sensN" min="0" max="1" step="0.01" value="0.70"/></div>
          <div class="muted mini">נמוך = עמידות</div>
        </div>

        <div class="ctl">
          <label>Demand שריר <span class="v" id="vDem">1.00</span></label>
          <input type="range" min="0.6" max="1.9" value="1.00" step="0.01" id="dem"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="demN" min="0.6" max="1.9" step="0.01" value="1.00"/></div>
          <div class="muted mini">ספורט → גבוה</div>
        </div>

        <div class="ctl">
          <label>Thr סף כליה <span class="v" id="vThr">180</span></label>
          <input type="range" min="120" max="240" value="180" step="1" id="thr"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="thrN" min="120" max="240" step="1" value="180"/></div>
          <div class="muted mini">מעל הסף מתחיל עומס</div>
        </div>

        <div class="ctl">
          <label>Tm קיבולת ספיגה <span class="v" id="vTm">40</span></label>
          <input type="range" min="0" max="140" value="40" step="1" id="tm"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="tmN" min="0" max="140" step="1" value="40"/></div>
          <div class="muted mini">אחרי Tm → איבוד</div>
        </div>

        <div class="ctl">
          <label>Gset יעד <span class="v" id="vSet">95</span></label>
          <input type="range" min="70" max="120" value="95" step="1" id="gset"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="gsetN" min="70" max="120" step="1" value="95"/></div>
        </div>

        <div class="ctl">
          <label>i0 בסיס אינסולין <span class="v" id="vi0">0.80</span></label>
          <input type="range" min="0" max="1.8" value="0.80" step="0.01" id="i0"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="i0N" min="0" max="1.8" step="0.01" value="0.80"/></div>
          <div class="muted mini">סוג 1 → נמוך</div>
        </div>

        <div class="ctl">
          <label>tauI דיליי אינסולין (דקות) <span class="v" id="vTauI">18</span></label>
          <input type="range" min="6" max="50" value="18" step="1" id="tauI"/>
          <div class="row2"><span class="muted mini">ערך</span><input type="number" id="tauIN" min="6" max="50" step="1" value="18"/></div>
          <div class="muted mini">גדול → איטי/overshoot</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn-primary" id="run">▶︎ הרץ סימולציה</button>
        <button id="reset">↩︎ איפוס</button>
      </div>

      <div class="hr"></div>

      <h3>תוצאות</h3>
      <div class="kbd" id="readout">לחץ “הרץ סימולציה”.</div>

      <h3 style="margin-top:14px">עומס תחנות (Station Load)</h3>
      <table>
        <thead>
          <tr><th>תחנה</th><th>סה״כ</th><th>שיא</th><th>הערה</th></tr>
        </thead>
        <tbody id="loadBody">
          <tr><td colspan="4" class="muted">הרץ סימולציה כדי למלא את הטבלה.</td></tr>
        </tbody>
      </table>

      <details style="margin-top:12px">
        <summary>מה יוצא ב-CSV?</summary>
        <div class="muted" style="margin-top:10px; line-height:1.7">
          זמן, G(t), I(t), וזרימות: U_muscle, U_fat, U_brain, R_liver(net), E_kidney.
        </div>
      </details>

      <div class="warn" style="margin-top:12px">
        <b>הערה:</b> הדמו חינוכי/הנדסי, לא לשימוש רפואי.
      </div>
    </aside>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmt(n, d=2){ return Number(n).toFixed(d); }
function sigmoid(x){ return 1/(1+Math.exp(-x)); }

/* ===== Mode ===== */
function setMode(mode){
  document.body.style.fontSize = (mode==="compact") ? "14px" : "15px";
  const eq = $("eqBlock");
  if(mode==="compact"){ eq.style.maxHeight = "180px"; eq.style.overflow = "auto"; }
  else { eq.style.maxHeight = "none"; eq.style.overflow = "visible"; }
  document.documentElement.style.setProperty('--shadow', (mode==="study") ? '0 12px 34px rgba(0,0,0,.10)' : '0 10px 28px rgba(0,0,0,.08)');
}
$("mode").addEventListener("change", (e)=>setMode(e.target.value));
setMode($("mode").value);

/* ===== Download self (works after you open file) ===== */
$("btnDownload").addEventListener("click", ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:"text/html;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "metabolic_railway_model_he_v3.html";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
});

/* ===== Range + Number sync ===== */
function bindPair(rangeId, numId, outId, formatOut){
  const r = $(rangeId), n = $(numId), o = outId ? $(outId) : null;
  const syncFromRange = ()=>{
    n.value = r.value;
    if(o) o.textContent = formatOut ? formatOut(r.value) : r.value;
  };
  const syncFromNum = ()=>{
    const v = clamp(parseFloat(n.value), parseFloat(r.min), parseFloat(r.max));
    if(!Number.isFinite(v)) return;
    r.value = String(v);
    if(o) o.textContent = formatOut ? formatOut(r.value) : r.value;
  };
  r.addEventListener("input", syncFromRange);
  n.addEventListener("input", syncFromNum);
  syncFromRange();
}
bindPair("meal","mealN","vMeal", v=>String(Math.round(parseFloat(v))));
bindPair("sens","sensN","vSens", v=>fmt(parseFloat(v),2));
bindPair("dem","demN","vDem", v=>fmt(parseFloat(v),2));
bindPair("thr","thrN","vThr", v=>String(Math.round(parseFloat(v))));
bindPair("tm","tmN","vTm", v=>String(Math.round(parseFloat(v))));
bindPair("gset","gsetN","vSet", v=>String(Math.round(parseFloat(v))));
bindPair("i0","i0N","vi0", v=>fmt(parseFloat(v),2));
bindPair("tauI","tauIN","vTauI", v=>String(Math.round(parseFloat(v))));

/* ===== Plotting helper ===== */
function makeCanvasPlot(canvas){
  const ctx = canvas.getContext("2d");
  function drawFrame(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth=1; ctx.strokeStyle="#e5e7eb";
    ctx.strokeRect(0.5,0.5,w-1,h-1);
    return {l:70,r:18,t:18,b:56,w,h};
  }
  function plot(series, ymin, ymax, opts){
    const m = drawFrame();
    const x0=m.l, y0=m.h-m.b, x1=m.w-m.r, y1=m.t;

    // axes
    ctx.strokeStyle="#111827";
    ctx.beginPath(); ctx.moveTo(x0,y1); ctx.lineTo(x0,y0); ctx.lineTo(x1,y0); ctx.stroke();

    // grid/ticks
    ctx.strokeStyle="#e5e7eb";
    ctx.fillStyle="#6b7280";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const yTicks=6;
    for(let i=0;i<=yTicks;i++){
      const y=y0-(y0-y1)*(i/yTicks);
      ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
      const v=ymin+(ymax-ymin)*(i/yTicks);
      ctx.fillText(String(Math.round(v)), 20, y+4);
    }
    const xTicks=6;
    for(let i=0;i<=xTicks;i++){
      const x=x0+(x1-x0)*(i/xTicks);
      ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
      const idx=Math.floor((series.t.length-1)*(i/xTicks));
      ctx.fillText(String(Math.round(series.t[idx])), x-10, m.h-30);
    }

    // title
    ctx.fillStyle="#111827";
    ctx.font="14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(opts.title || "", 12, 18);

    // line
    ctx.strokeStyle = opts.color || "#2563eb";
    ctx.lineWidth = 3;
    ctx.beginPath();
    for(let i=0;i<series.t.length;i++){
      const x=x0+(x1-x0)*(i/(series.t.length-1));
      const y=y0-(y0-y1)*((series.y[i]-ymin)/(ymax-ymin));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // ref lines
    if(opts.refLines){
      for(const rl of opts.refLines){
        const yRef=y0-(y0-y1)*((rl.value-ymin)/(ymax-ymin));
        ctx.strokeStyle=rl.stroke; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(x0, yRef); ctx.lineTo(x1, yRef); ctx.stroke();
        ctx.fillStyle=rl.fill;
        ctx.fillText(rl.label, x1- (rl.label.length*6+14), yRef-6);
      }
    }
  }
  return {plot};
}

const plotG = makeCanvasPlot($("plotG"));
const plotI = makeCanvasPlot($("plotI"));

/* ===== Simulation ===== */
let lastSim = null; // store for CSV export

function simulate(params){
  const {
    A,S,Demand,Thr,Tm,Gset,i0,tauI,
    tEnd,dt,tMeal,tauMeal,
    VmaxM,VmaxF,Vbrain, KI, KG, Kbrain,
    r0,rG,rI, Lmax, kStore, kRelease
  } = params;

  let G = Gset;
  let I = i0;
  let L = 0.55*Lmax;

  const n = Math.floor(tEnd/dt)+1;
  const t = new Array(n);
  const Gs = new Array(n);
  const Is = new Array(n);

  const UM = new Array(n);
  const UF = new Array(n);
  const UB = new Array(n);
  const RL = new Array(n);
  const EK = new Array(n);

  for(let i=0;i<n;i++){
    const ti = i*dt;

    const P_gut = (ti>=tMeal) ? (A * Math.exp(-(ti-tMeal)/tauMeal)) : 0;

    const I_target = i0 + 1.2 * sigmoid((G - Gset)/10);
    const dI = (I_target - I)/tauI;
    I = clamp(I + dt*dI, 0, 3.5);

    const insulinGate = (S*I) / (KI + S*I + 1e-9);
    const glucoseGate = (G) / (KG + G + 1e-9);

    const u_muscle = VmaxM * insulinGate * glucoseGate * Demand;
    const u_fat    = VmaxF * insulinGate * glucoseGate;
    const u_brain  = Vbrain * (G) / (Kbrain + G + 1e-9);

    let R = r0 + rG*Math.max(0, Gset - G) - rI*I;

    const store = kStore * insulinGate * glucoseGate;
    const release = kRelease * Math.max(0, (Gset - G)/Gset);
    const dL = (store - release);

    L = clamp(L + dt*dL, 0, Lmax);

    if(L < 0.05*Lmax && R > r0) R = r0 + 0.3*(R-r0);

    const R_net = R - 0.6*store;

    const over = Math.max(0, G - Thr);
    const exLoss = Math.max(0, over - Tm);
    const E = 0.020 * exLoss;

    const dG = P_gut + R_net - (u_muscle + u_fat + u_brain) - E;
    G = clamp(G + dt*dG, 30, 450);

    t[i]=ti; Gs[i]=G; Is[i]=I;
    UM[i]=u_muscle; UF[i]=u_fat; UB[i]=u_brain; RL[i]=R_net; EK[i]=E;
  }

  return {t, G:Gs, I:Is, UM, UF, UB, RL, EK};
}

function integrate(series, dt){ let s=0; for(const v of series) s += v*dt; return s; }
function maxOf(series){ let m=-Infinity; for(const v of series) if(v>m) m=v; return m; }
function summarizeG(sim, Thr){
  const G = sim.G;
  let min=Infinity,max=-Infinity,sum=0;
  for(const v of G){ if(v<min)min=v; if(v>max)max=v; sum+=v; }
  const avg=sum/G.length;
  let above=0;
  for(let i=1;i<G.length;i++){
    if(G[i]>Thr) above += (sim.t[i]-sim.t[i-1]);
  }
  return {min,max,avg,above};
}

function renderLoads(sim, dt){
  const loads = [
    {name:"שריר", total: integrate(sim.UM, dt), peak: maxOf(sim.UM), note:"קליטה תלויה I,S,Demand"},
    {name:"שומן", total: integrate(sim.UF, dt), peak: maxOf(sim.UF), note:"קליטה תלויה I,S"},
    {name:"מוח", total: integrate(sim.UB, dt), peak: maxOf(sim.UB), note:"קליטה כמעט קבועה"},
    {name:"כבד→דם", total: integrate(sim.RL, dt), peak: maxOf(sim.RL), note:"שחרור נטו לדם"},
    {name:"כליה (איבוד)", total: integrate(sim.EK, dt), peak: maxOf(sim.EK), note:"איבוד לאחר Thr+Tm"}
  ];
  const tbody = $("loadBody");
  tbody.innerHTML = "";
  for(const L of loads){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${L.name}</td><td>${fmt(L.total,2)}</td><td>${fmt(L.peak,2)}</td><td>${L.note}</td>`;
    tbody.appendChild(tr);
  }
}

function run(){
  const A = parseFloat($("meal").value);
  const S = parseFloat($("sens").value);
  const Demand = parseFloat($("dem").value);
  const Thr = parseFloat($("thr").value);
  const Tm = parseFloat($("tm").value);
  const Gset = parseFloat($("gset").value);
  const i0 = parseFloat($("i0").value);
  const tauI = parseFloat($("tauI").value);

  const dt = 0.5;
  const sim = simulate({
    A,S,Demand,Thr,Tm,Gset,i0,tauI,
    tEnd:240, dt,
    tMeal:20, tauMeal:35,
    VmaxM: 3.3, VmaxF: 2.1, Vbrain: 1.2,
    KI: 0.55, KG: 110, Kbrain: 70,
    r0: 0.30, rG: 0.055, rI: 0.22,
    Lmax: 90, kStore: 1.6, kRelease: 1.0
  });
  lastSim = {dt, Thr, params:{A,S,Demand,Thr,Tm,Gset,i0,tauI}, sim};

  const sg = summarizeG(sim, Thr);

  const yminG = Math.max(40, Math.floor((sg.min-25)/10)*10);
  const ymaxG = Math.min(450, Math.ceil((sg.max+25)/10)*10);
  plotG.plot({t:sim.t, y:sim.G}, yminG, ymaxG, {
    title:"G(t) גלוקוז (mg/dL)",
    color:"#2563eb",
    refLines:[
      {value:Gset, stroke:"rgba(22,163,74,.85)", fill:"rgba(22,163,74,.95)", label:"יעד Gset"},
      {value:Thr,  stroke:"rgba(245,158,11,.90)", fill:"rgba(245,158,11,.95)", label:"סף Thr"}
    ]
  });

  const minI = Math.min(...sim.I);
  const maxI = Math.max(...sim.I);
  const yminI = Math.max(0, Math.floor((minI-0.2)*10)/10);
  const ymaxI = Math.ceil((maxI+0.2)*10)/10;
  plotI.plot({t:sim.t, y:sim.I}, yminI, ymaxI, {
    title:"I(t) אינסולין (יחידות מודליות)",
    color:"#111827",
    refLines:[]
  });

  renderLoads(sim, dt);

  const status =
    (sg.max < 160 && sg.min > 70) ? "יציב יחסית" :
    (sg.max >= 200) ? "שיא גבוה" :
    (sg.min <= 65) ? "נמוך מדי" : "ביניים";

  $("readout").textContent =
`תוצאות (4 שעות):
• מינימום G: ${Math.round(sg.min)} mg/dL
• ממוצע G:  ${Math.round(sg.avg)} mg/dL
• מקסימום G: ${Math.round(sg.max)} mg/dL
• זמן מעל Thr (${Thr}) : ${Math.round(sg.above)} דקות
• מצב כללי: ${status}

פרשנות:
- הורד S → עמידות לאינסולין → שיא גבוה + ירידה איטית.
- העלה Demand → “ספורט” → השריר קולט יותר → G יורד מהר יותר.
- העלה tauI → תגובה איטית/דיליי → overshoot אפשרי.
- הורד Tm → קיבולת כליה נמוכה → יותר איבוד.`;
}

/* ===== CSV Export ===== */
function exportCSV(){
  if(!lastSim){ alert("אין נתונים עדיין. הרץ סימולציה קודם."); return; }
  const {sim} = lastSim;
  const headers = ["t_min","G_mg_dL","I_model","U_muscle","U_fat","U_brain","R_liver_net","E_kidney"];
  const lines = [headers.join(",")];
  for(let i=0;i<sim.t.length;i++){
    const row = [
      sim.t[i].toFixed(2),
      sim.G[i].toFixed(4),
      sim.I[i].toFixed(4),
      sim.UM[i].toFixed(6),
      sim.UF[i].toFixed(6),
      sim.UB[i].toFixed(6),
      sim.RL[i].toFixed(6),
      sim.EK[i].toFixed(6),
    ];
    lines.push(row.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "metabolic_railway_export.csv";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
$("btnExportCSV").addEventListener("click", exportCSV);

/* ===== Presets ===== */
function applyPreset(p){
  $("meal").value = p.A; $("meal").dispatchEvent(new Event("input"));
  $("sens").value = p.S; $("sens").dispatchEvent(new Event("input"));
  $("dem").value  = p.D; $("dem").dispatchEvent(new Event("input"));
  $("thr").value  = p.Thr; $("thr").dispatchEvent(new Event("input"));
  $("tm").value   = p.Tm; $("tm").dispatchEvent(new Event("input"));
  $("gset").value = p.Gset; $("gset").dispatchEvent(new Event("input"));
  $("i0").value   = p.i0; $("i0").dispatchEvent(new Event("input"));
  $("tauI").value = p.tauI; $("tauI").dispatchEvent(new Event("input"));
}
$("scHealthy").addEventListener("click", ()=>applyPreset({A:80,S:0.78,D:1.00,Thr:180,Tm:40,Gset:95,i0:0.85,tauI:16}));
$("scResistance").addEventListener("click", ()=>applyPreset({A:90,S:0.32,D:1.00,Thr:180,Tm:40,Gset:95,i0:0.95,tauI:20}));
$("scT1").addEventListener("click", ()=>applyPreset({A:90,S:0.80,D:1.00,Thr:180,Tm:40,Gset:95,i0:0.05,tauI:22}));
$("scSport").addEventListener("click", ()=>applyPreset({A:70,S:0.75,D:1.35,Thr:180,Tm:40,Gset:95,i0:0.85,tauI:14}));
$("scBigMeal").addEventListener("click", ()=>applyPreset({A:170,S:0.75,D:1.00,Thr:180,Tm:40,Gset:95,i0:0.85,tauI:16}));

/* ===== Run/Reset ===== */
function resetAll(){
  applyPreset({A:80,S:0.70,D:1.00,Thr:180,Tm:40,Gset:95,i0:0.80,tauI:18});
  $("readout").textContent = "לחץ “הרץ סימולציה”.";
  $("loadBody").innerHTML = '<tr><td colspan="4" class="muted">הרץ סימולציה כדי למלא את הטבלה.</td></tr>';
  lastSim = null;
  // clear canvases
  const c1=$("plotG").getContext("2d"); c1.clearRect(0,0,$("plotG").width,$("plotG").height);
  const c2=$("plotI").getContext("2d"); c2.clearRect(0,0,$("plotI").width,$("plotI").height);
}
$("run").addEventListener("click", run);
$("runTop").addEventListener("click", run);
$("reset").addEventListener("click", resetAll);
$("resetTop").addEventListener("click", resetAll);

// bind mode already, init
resetAll();
</script>
</body>
</html>
