<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="pageTitle">דף הבית</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --head:#111827;
      --link:#2563eb;
      --shadow:0 6px 18px rgba(0,0,0,0.08);
      --r:12px;

      /* category colors */
      --c-net:#0ea5e9;
      --c-ui:#a855f7;
      --c-id:#22c55e;
      --c-med:#f97316;
      --c-elec:#f59e0b;
      --c-thermo:#ef4444;
      --c-audio:#14b8a6;
      --c-floor:#64748b;
      --c-water:#3b82f6;
      --c-transport:#10b981;
      --c-hybrid:#06b6d4;
      --c-bio:#8b5cf6;

      /* tag colors */
      --tag-bg:#eef2ff;
      --tag-bd:#c7d2fe;
      --tag-tx:#3730a3;

      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
    }

    *{box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background:var(--bg);
      margin:30px;
      user-select:none;
      color:var(--text);
    }

    h1{ margin:0 0 14px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:14px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-bottom:10px;
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
    }

    label{
      font-weight:bold;
      font-size:13px;
      color:#374151;
    }

    input, select, button{
      padding:10px 12px;
      font-size:15px;
      border-radius:10px;
      border:1px solid var(--line);
      background:white;
      outline:none;
    }

    input:focus, select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }

    .langbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .langbtn{
      cursor:pointer;
      border:1px solid var(--line);
      background:white;
      border-radius:999px;
      padding:8px 10px;
      font-weight:bold;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }

    .langbtn.active{
      border-color:#111827;
      box-shadow:0 6px 16px rgba(17,24,39,0.12);
      transform:translateY(-1px);
    }

    .summary{
      margin:6px 0 6px;
      color:var(--muted);
      font-size:14px;
    }

    .summary strong{ color:#111827; }

    .pillrow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }

    .active-tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      color:#3730a3;
      font-weight:bold;
      font-size:13px;
    }
    .active-tag button{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:16px;
      padding:0 2px;
      color:#3730a3;
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
      border-radius:var(--r);
      overflow:hidden;
      box-shadow:var(--shadow);
    }

    th, td{
      padding:14px;
      border-bottom:1px solid var(--line);
      text-align:right;
      vertical-align:top;
    }

    th{
      background:var(--head);
      color:white;
      font-size:16px;
      position:sticky;
      top:0;
      z-index:2;
    }

    tr:last-child td{border-bottom:none}

    a{
      color:var(--link);
      text-decoration:none;
      font-weight:bold;
    }
    a:hover{ text-decoration:underline; }

    .topic{
      font-weight:bold;
      color:#374151;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .badge{
      font-size:12px;
      font-weight:bold;
      padding:4px 10px;
      border-radius:999px;
      color:white;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .b-net{background:var(--c-net)}
    .b-ui{background:var(--c-ui)}
    .b-id{background:var(--c-id)}
    .b-med{background:var(--c-med)}
    .b-elec{background:var(--c-elec)}
    .b-thermo{background:var(--c-thermo)}
    .b-audio{background:var(--c-audio)}
    .b-floor{background:var(--c-floor)}
    .b-water{background:var(--c-water)}
    .b-transport{background:var(--c-transport)}
    .b-hybrid{background:var(--c-hybrid)}
    .b-bio{background:var(--c-bio)}

    .desc{ color:#111827; line-height:1.5; }
    .muted{ color:var(--muted); font-size:13px; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top:8px;
    }

    .smallbtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f9fafb;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .smallbtn:hover{ background:#eef2ff; }

    .smallbtn.danger{ border-color:#fecaca; background:#fff1f2; }
    .smallbtn.danger:hover{ background:#ffe4e6; }

    .smallbtn.ok{ border-color:#bbf7d0; background:#f0fdf4; }
    .smallbtn.ok:hover{ background:#dcfce7; }

    .fav-wrap{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .favbtn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f9fafb;
      cursor:pointer;
      font-size:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:transform .12s ease, background .12s ease, border .12s ease;
    }
    .favbtn:hover{ background:#fff7ed; border-color:#fdba74; transform:translateY(-1px); }
    .favbtn.active{ background:#fffbeb; border-color:#f59e0b; }

    .favpill{
      display:none;
      font-size:12px;
      font-weight:bold;
      padding:3px 8px;
      border-radius:999px;
      background:#fffbeb;
      border:1px solid #f59e0b;
      color:#92400e;
      white-space:nowrap;
    }
    tr.fav .favpill{ display:inline-flex; }

    .fav-only{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:white;
      height:42px;
    }
    .fav-only input{ width:18px; height:18px; }

    .empty{
      margin-top:12px;
      padding:14px;
      border-radius:12px;
      background:white;
      border:1px dashed #cbd5e1;
      color:#475569;
      display:none;
    }

    .tagbar{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      font-weight:bold;
      padding:4px 8px;
      border-radius:999px;
      background:var(--tag-bg);
      border:1px solid var(--tag-bd);
      color:var(--tag-tx);
      cursor:pointer;
      user-select:none;
    }
    .tag:hover{ filter:brightness(0.98); transform:translateY(-1px); }
    .tag.selected{
      background:#111827;
      border-color:#111827;
      color:#fff;
    }

    /* 🔒 חסימת הדפסה */
    @media print { body { display: none !important; } }

    /* 💧 סימן מים (ללא שם אישי) */
    body::before {
      content: "© כל הזכויות שמורות – קלנסווה";
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 48px;
      color: rgba(0,0,0,0.08);
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
    }

    footer{
      margin-top:40px;
      padding:15px;
      background:#111827;
      color:#f9fafb;
      text-align:center;
      font-size:14px;
      border-radius:8px;
      line-height:1.6;
    }

    /* Mobile: convert table into cards */
    @media (max-width: 820px){
      body{ margin:14px; }
      th{ position:static; }
      table, thead, tbody, tr, td, th{ display:block; width:100%; }
      thead{ display:none; }
      tr{
        border-bottom:1px solid var(--line);
        padding:12px;
      }
      table{
        overflow:visible;
        border-radius:14px;
      }
      tr:last-child{ border-bottom:none; }
      td{
        border-bottom:none;
        padding:8px 0;
        text-align:right;
      }
      td[data-label]::before{
        content: attr(data-label);
        display:block;
        font-weight:bold;
        color:#334155;
        margin-bottom:6px;
        font-size:13px;
      }
      .control{ min-width: 100%; }
      .topbar{ align-items:stretch; }
      .langbar{ justify-content:flex-start; }
      .favbtn{ width:40px; height:40px; }
    }

    /* LTR fixes */
    [dir="ltr"] th, [dir="ltr"] td{ text-align:left; }

    /* ✅ FIX: נושא + קישור באותו גובה */
    #indexTable th,
    #indexTable td{
      vertical-align: middle;
    }
    #indexTable td.topic{
      display:flex;
      align-items:center;
    }
    #indexTable .fav-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    #indexTable .fav-wrap > div{
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    /* ✅ Viewer Modal */
    .viewer{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      z-index:999999;
      padding:14px;
    }
    .viewer.open{ display:block; }

    .viewer-inner{
      background:#fff;
      height:100%;
      width:100%;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
    }

    .viewer-bar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #e5e7eb;
      background:#111827;
      color:#fff;
    }

    .viewer-title{
      flex:1;
      font-weight:bold;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .viewer-btn{
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.08);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
    }
    .viewer-btn:hover{ background:rgba(255,255,255,0.16); }

    .viewer-frame{
      border:0;
      width:100%;
      height:100%;
      background:#fff;
    }

    /* ✅ Graph modal */
    .graph{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      z-index:999998;
      padding:14px;
    }
    .graph.open{ display:block; }
    .graph-inner{
      background:#fff;
      height:100%;
      width:100%;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
    }
    .graph-bar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #e5e7eb;
      background:#111827;
      color:#fff;
    }
    .graph-title{ flex:1; font-weight:bold; }
    .graph-canvas{ flex:1; width:100%; height:100%; display:block; background:#fff; }
    .hint{
      color:#e5e7eb;
      font-size:12px;
      opacity:.9;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div>
      <h1 data-i18n="welcome">ברוכים הבאים</h1>
      <div class="summary">
        <span data-i18n="summaryPrefix">סך הכל קבצים:</span>
        <strong id="countAll">0</strong>
        ·
        <span data-i18n="summaryShown">מוצגים כעת:</span>
        <strong id="countShown">0</strong>
        ·
        <span data-i18n="summaryFav">מועדפים:</span>
        <strong id="countFav">0</strong>
      </div>

      <div class="pillrow" id="activeTagsRow" style="display:none;"></div>
    </div>

    <div class="langbar" aria-label="Language selector">
      <button class="langbtn active" data-lang="he">🇮🇱 <span>עברית</span></button>
      <button class="langbtn" data-lang="en">🌍 <span>English</span></button>
      <button class="langbtn" data-lang="ar">🇵🇸 <span>العربية</span></button>
      <button class="langbtn" data-lang="ru">🇷🇺 <span>Русский</span></button>
    </div>
  </div>

  <div class="controls">
    <div class="control">
      <label for="search" data-i18n="searchLabel">חיפוש</label>
      <input id="search" type="text" placeholder="הקלד מילה/שם קובץ/תיאור/תגית…" data-i18n-ph="searchPh">
      <div class="muted" data-i18n="searchHint">מחפש בתוך נושא, שם קובץ, תיאור, תגיות ואיברים.</div>
    </div>

    <div class="control">
      <label for="category" data-i18n="filterLabel">סינון לפי קטגוריה</label>
      <select id="category">
        <option value="all" data-i18n="filterAll">הכל</option>
        <option value="net" data-i18n="catNet">תקשורת ורשתות</option>
        <option value="ui" data-i18n="catUi">ממשק אדם–מסך</option>
        <option value="id" data-i18n="catId">זיהוי זהות</option>
        <option value="med" data-i18n="catMed">רפואה חכמה</option>
        <option value="bio" data-i18n="catBio">מודלים ביולוגיים</option>
        <option value="elec" data-i18n="catElec">חשמל וסימולציות</option>
        <option value="thermo" data-i18n="catThermo">תרמודינמיקה</option>
        <option value="audio" data-i18n="catAudio">אנרגיה וקול</option>
        <option value="floor" data-i18n="catFloor">אנרגיה מהרצפה</option>
        <option value="water" data-i18n="catWater">תנועה על מים</option>
        <option value="transport" data-i18n="catTransport">תחבורה</option>
        <option value="hybrid" data-i18n="catHybrid">הנעה היברידית</option>
      </select>

      <div class="actions">
        <button class="smallbtn" id="resetBtn" data-i18n="resetBtn">איפוס</button>
        <button class="smallbtn ok" id="openAllBtn" data-i18n="openAllBtn">פתח קישור ראשון (ב־Viewer)</button>
        <button class="smallbtn" id="openAllTabsBtn" data-i18n="openAllTabsBtn">פתח את כולם בלשוניות</button>
      </div>
    </div>

    <div class="control">
      <label for="organ" data-i18n="organLabel">סינון לפי איבר</label>
      <select id="organ">
        <option value="all" data-i18n="organAll">הכל</option>
        <option value="pancreas" data-i18n="organPancreas">לבלב</option>
        <option value="liver" data-i18n="organLiver">כבד</option>
        <option value="kidney" data-i18n="organKidney">כליות</option>
        <option value="heart" data-i18n="organHeart">לב</option>
        <option value="lung" data-i18n="organLung">ריאות</option>
        <option value="spleen" data-i18n="organSpleen">טחול</option>
        <option value="blood" data-i18n="organBlood">דם</option>
        <option value="air" data-i18n="organAir">אוויר/נשימה</option>
        <option value="skin" data-i18n="organSkin">עור</option>
      </select>

      <div class="actions">
        <button class="smallbtn" id="graphBtn" data-i18n="graphBtn">מפת קשרים (Graph)</button>
        <button class="smallbtn danger" id="clearFavBtn" data-i18n="clearFavBtn">נקה מועדפים</button>
      </div>
    </div>

    <div class="control">
      <label data-i18n="sortLabel">מיון</label>
      <select id="sort">
        <option value="default" data-i18n="sortDefault">ברירת מחדל</option>
        <option value="title" data-i18n="sortTitle">לפי כותרת</option>
        <option value="file" data-i18n="sortFile">לפי שם קובץ</option>
        <option value="favFirst" data-i18n="sortFavFirst">מועדפים בראש</option>
      </select>

      <label data-i18n="favOnlyLabel" style="margin-top:8px;">תצוגה</label>
      <div class="fav-only">
        <input type="checkbox" id="favOnly">
        <span data-i18n="favOnlyText">הצג מועדפים בלבד</span>
      </div>
      <div class="muted" data-i18n="favHint">הכוכב נשמר בדפדפן (LocalStorage).</div>
    </div>
  </div>

  <div class="empty" id="emptyBox" data-i18n="empty">
    לא נמצאו תוצאות. נסה לשנות את החיפוש או לבחור קטגוריה/איבר אחרת.
  </div>

  <table id="indexTable">
    <thead>
      <tr>
        <th data-i18n="thTopic">נושא</th>
        <th data-i18n="thLink">שם הקובץ / קישור</th>
        <th data-i18n="thDesc">תיאור</th>
      </tr>
    </thead>
    <tbody>

      <!-- ===================== -->
      <!-- ✅ LIST OF ALL FILES  -->
      <!-- ===================== -->

      <tr class="row" data-cat="net"
          data-key="usb_network_osi_ipv6_plus_hw_usecase.html"
          data-org=""
          data-tags="usb,network,osi,ipv6,ipv4,protocol,hardware">
        <td class="topic" data-label="נושא">
          <span class="badge b-net" data-i18n="badgeNet">🌐🔌 תקשורת ורשתות</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="usb_network_osi_ipv6_plus_hw_usecase.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="usb_network_osi_ipv6_plus_hw_usecase.html" data-i18n="linkUsb">USB + רשת (OSI + IPv6)</a>
              <div class="muted">usb_network_osi_ipv6_plus_hw_usecase.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="usb">#usb</span>
                <span class="tag" data-tag="ipv6">#ipv6</span>
                <span class="tag" data-tag="osi">#osi</span>
                <span class="tag" data-tag="hardware">#hardware</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descUsb">
          חיבור USB כרשת מלאה לפי מודל 7 השכבות, כולל IPv4/IPv6, תרשים חומרה ותרחיש שימוש מעשי
        </td>
      </tr>

      <tr class="row" data-cat="ui"
          data-key="fingerprint_gesture_full_v5_he.html"
          data-org="skin"
          data-tags="fingerprint,gesture,ui,screen,biometric,auth">
        <td class="topic" data-label="נושא">
          <span class="badge b-ui" data-i18n="badgeUi">🖐️📺 ממשק אדם–מסך</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="fingerprint_gesture_full_v5_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="fingerprint_gesture_full_v5_he.html" data-i18n="linkFp">מסכים חכמים לפי טביעת אצבע</a>
              <div class="muted">fingerprint_gesture_full_v5_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="fingerprint">#fingerprint</span>
                <span class="tag" data-tag="gesture">#gesture</span>
                <span class="tag" data-tag="auth">#auth</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descFp">
          מערכת מסכים אינטראקטיבית המגיבה לטביעת אצבע ומחוות, כולל אימות משתמש, אלגוריתמים ודמו מלא
        </td>
      </tr>

      <tr class="row" data-cat="ui"
          data-key="new 8.html"
          data-org="skin"
          data-tags="lighting,biometric,fingerprint,pointing,ui,security">
        <td class="topic" data-label="נושא">
          <span class="badge b-ui" data-i18n="badgeLightBio">💡🖐️ תאורה חכמה ביומטרית</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="new 8.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="new%208.html" data-i18n="linkLightBio">תאורה ללא מפסיקים — הצבעה + טביעת אצבע</a>
              <div class="muted">new 8.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="lighting">#lighting</span>
                <span class="tag" data-tag="biometric">#biometric</span>
                <span class="tag" data-tag="security">#security</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descLightBio">
          דף מערכת מלא: ארכיטקטורה, תרשימים, אבטחה, סימולציה ופרוטוטייפ להפעלת נר/תאורה בהצבעה ואימות ביומטרי
        </td>
      </tr>

      <tr class="row" data-cat="id"
          data-key="bivdn_multilang_full_mobile.html"
          data-org=""
          data-tags="identity,mobile,multilang,verification,ui">
        <td class="topic" data-label="נושא">
          <span class="badge b-id" data-i18n="badgeId">📱🌍 זיהוי זהות רב־לשוני</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="bivdn_multilang_full_mobile.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="bivdn_multilang_full_mobile.html" data-i18n="linkBivdn">BIVDN – זיהוי זהות נייד</a>
              <div class="muted">bivdn_multilang_full_mobile.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="identity">#identity</span>
                <span class="tag" data-tag="multilang">#multilang</span>
                <span class="tag" data-tag="mobile">#mobile</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descBivdn">
          מערכת זיהוי דיגיטלית רב־לשונית למובייל: אימות זהות, ממשק רספונסיבי, תמיכה בשפות מרובות והתאמה למסכים קטנים
        </td>
      </tr>

      <tr class="row" data-cat="med"
          data-key="bio_magnet_therapy.html"
          data-org="blood,heart"
          data-tags="drug,delivery,dna,magnet,gps,therapy,patch">
        <td class="topic" data-label="נושא">
          <span class="badge b-med" data-i18n="badgeMed">🧬🧲 רפואה חכמה</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="bio_magnet_therapy.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="bio_magnet_therapy.html" data-i18n="linkBio">מגנט ביולוגי להולכת תרופות</a>
              <div class="muted">bio_magnet_therapy.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="drug">#drug</span>
                <span class="tag" data-tag="dna">#dna</span>
                <span class="tag" data-tag="therapy">#therapy</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descBio">
          מודל מחקרי להחלפת אינפוזיה: טלאי חכם המבוסס על DNA, חתימה חשמלית וניווט טיפולי ("GPS ביולוגי") בגוף האדם
        </td>
      </tr>

      <tr class="row" data-cat="thermo"
          data-key="plant_gas_to_bio_oil_mvp_he.html"
          data-org=""
          data-tags="plants,gas,biooil,urban,thermal,conversion">
        <td class="topic" data-label="נושא">
          <span class="badge b-thermo" data-i18n="badgePlantOil">🌱🛢️ גזים → נפט ביולוגי</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="plant_gas_to_bio_oil_mvp_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="plant_gas_to_bio_oil_mvp_he.html" data-i18n="linkPlantOil">המרת גזים מצמחים לנפט ביולוגי (MVP)</a>
              <div class="muted">plant_gas_to_bio_oil_mvp_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="plants">#plants</span>
                <span class="tag" data-tag="gas">#gas</span>
                <span class="tag" data-tag="thermal">#thermal</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descPlantOil">
          מודל MVP להפקת נפט ביולוגי מגזים הנפלטים מצמחים בחללים סגורים: לכידה, פירוק, תהליך חום ויישום עירוני.
        </td>
      </tr>

      <tr class="row" data-cat="med"
          data-key="patent_clean_air_square_zone_he.html"
          data-org="lung,air"
          data-tags="cleanair,airflow,filter,particles,hospital,zone">
        <td class="topic" data-label="נושא">
          <span class="badge b-med" data-i18n="badgeCleanAir">🧼🫁 אזור אוויר נקי</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="patent_clean_air_square_zone_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="patent_clean_air_square_zone_he.html" data-i18n="linkCleanAir">פטנט: אזור אוויר נקי ריבועי (Clean-Air Zone)</a>
              <div class="muted">patent_clean_air_square_zone_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="cleanair">#cleanair</span>
                <span class="tag" data-tag="hospital">#hospital</span>
                <span class="tag" data-tag="particles">#particles</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descCleanAir">
          יצירת “בועת” אוויר נקי ריבועית סביב מטופל/אזור מוגדר באמצעות אספקת אוויר, פיזור מבוקר וניטור חלקיקים/מזהמים.
        </td>
      </tr>

      <tr class="row" data-cat="bio"
          data-key="metabolic_railway_model_he_v3.html"
          data-org="pancreas,liver,kidney,blood,spleen"
          data-tags="metabolism,pancreas,insulin,glucose,liver,kidney,spleen,railway,stations,homeostasis">
        <td class="topic" data-label="נושא">
          <span class="badge b-bio" data-i18n="badgeMetabolicRail">🚆🧬 מודל רכבת מטבולית</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="metabolic_railway_model_he_v3.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="metabolic_railway_model_he_v3.html" data-i18n="linkMetabolicRail">מודל רכבת מטבולית – ויסות חומרים בגוף</a>
              <div class="muted">metabolic_railway_model_he_v3.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="pancreas">#pancreas</span>
                <span class="tag" data-tag="glucose">#glucose</span>
                <span class="tag" data-tag="homeostasis">#homeostasis</span>
                <span class="tag" data-tag="stations">#stations</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descMetabolicRail">
          מודל ביולוגי־מערכתי: הלבלב כתחנת מקור מרכזית, והאיברים כתחנות “רכבת” מטבוליות לפירוק/ויסות והזרמת סוכר, נוזלים וחומרים – לשמירה על איזון פנימי.
        </td>
      </tr>

      <tr class="row" data-cat="elec"
          data-key="electricity_models_plus_simulations_bilingual_toggle.html"
          data-org=""
          data-tags="electricity,physics,simulation,model,interactive">
        <td class="topic" data-label="נושא">
          <span class="badge b-elec" data-i18n="badgeElec">⚡ חשמל וסימולציות</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="electricity_models_plus_simulations_bilingual_toggle.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="electricity_models_plus_simulations_bilingual_toggle.html" data-i18n="linkElec">מודל חשמל + סימולציות</a>
              <div class="muted">electricity_models_plus_simulations_bilingual_toggle.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="electricity">#electricity</span>
                <span class="tag" data-tag="simulation">#simulation</span>
                <span class="tag" data-tag="interactive">#interactive</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descElec">מודלים פיזיקליים, משוואות וסימולציות אינטראקטיביות</td>
      </tr>

      <tr class="row" data-cat="thermo"
          data-key="thermosiphon_flow_calculator_he.html"
          data-org=""
          data-tags="thermosiphon,flow,calculator,physics,heat">
        <td class="topic" data-label="נושא">
          <span class="badge b-thermo" data-i18n="badgeThermo">🔥 תרמודינמיקה</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="thermosiphon_flow_calculator_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="thermosiphon_flow_calculator_he.html" data-i18n="linkThermo">תרמוסיפון</a>
              <div class="muted">thermosiphon_flow_calculator_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="heat">#heat</span>
                <span class="tag" data-tag="flow">#flow</span>
                <span class="tag" data-tag="calculator">#calculator</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descThermo">מחשבון זרימה תרמוסיפונית לפי פרמטרים פיזיקליים</td>
      </tr>

      <tr class="row" data-cat="audio"
          data-key="self_charging_headphones_FULL_katex_diagrams_simulation_explained.html"
          data-org=""
          data-tags="audio,energy,headphones,selfcharging,harvesting,signal">
        <td class="topic" data-label="נושא">
          <span class="badge b-audio" data-i18n="badgeAudio">🎧 אנרגיה וקול</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="self_charging_headphones_FULL_katex_diagrams_simulation_explained.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="self_charging_headphones_FULL_katex_diagrams_simulation_explained.html" data-i18n="linkAudio">אוזניות נטענות מעצמן</a>
              <div class="muted">self_charging_headphones_FULL_katex_diagrams_simulation_explained.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="audio">#audio</span>
                <span class="tag" data-tag="energy">#energy</span>
                <span class="tag" data-tag="harvesting">#harvesting</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descAudio">טעינה עצמית מאנרגיית קול – מודל תאורטי וסימולציה</td>
      </tr>

      <tr class="row" data-cat="floor"
          data-key="smart_floor_pressure_to_energy_model_he.html"
          data-org=""
          data-tags="floor,energy,pressure,harvesting,loads">
        <td class="topic" data-label="נושא">
          <span class="badge b-floor" data-i18n="badgeFloor">🧱⚡ אנרגיה מהרצפה</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="smart_floor_pressure_to_energy_model_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="smart_floor_pressure_to_energy_model_he.html" data-i18n="linkFloor">מודל רצפה חכמה</a>
              <div class="muted">smart_floor_pressure_to_energy_model_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="floor">#floor</span>
                <span class="tag" data-tag="pressure">#pressure</span>
                <span class="tag" data-tag="energy">#energy</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descFloor">הפקת אנרגיה מלחץ ומיפוי עומסים</td>
      </tr>

      <tr class="row" data-cat="water"
          data-key="water_walking_shoes_sonar_pump.html"
          data-org=""
          data-tags="water,shoes,sonar,pump,balance">
        <td class="topic" data-label="נושא">
          <span class="badge b-water" data-i18n="badgeWater">🌊👟 תנועה על מים</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="water_walking_shoes_sonar_pump.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="water_walking_shoes_sonar_pump.html" data-i18n="linkWater">נעליים להליכה על מים</a>
              <div class="muted">water_walking_shoes_sonar_pump.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="water">#water</span>
                <span class="tag" data-tag="sonar">#sonar</span>
                <span class="tag" data-tag="pump">#pump</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descWater">סונאר, משאבות זעירות ושיווי־משקל דינמי</td>
      </tr>

      <tr class="row" data-cat="transport"
          data-key="water_gas_train_blue.html"
          data-org=""
          data-tags="train,transport,water,gas,efficiency">
        <td class="topic" data-label="נושא">
          <span class="badge b-transport" data-i18n="badgeTransport">🚆💧 תנועה ותחבורה</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="water_gas_train_blue.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="water_gas_train_blue.html" data-i18n="linkTrain">רכבת מים–גז (Blue)</a>
              <div class="muted">water_gas_train_blue.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="train">#train</span>
                <span class="tag" data-tag="transport">#transport</span>
                <span class="tag" data-tag="efficiency">#efficiency</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descTrain">תחבורה מבוססת מים וגז עם יעילות אנרגטית</td>
      </tr>

      <tr class="row" data-cat="hybrid"
          data-key="water_air_shoes_trilingual_flow.html"
          data-org=""
          data-tags="hybrid,water,air,shoes,flow,trilingual">
        <td class="topic" data-label="נושא">
          <span class="badge b-hybrid" data-i18n="badgeHybrid">🌊🌬️ הנעה היברידית</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="water_air_shoes_trilingual_flow.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="water_air_shoes_trilingual_flow.html" data-i18n="linkHybrid">נעליים מים–אוויר (תלת־לשוני)</a>
              <div class="muted">water_air_shoes_trilingual_flow.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="hybrid">#hybrid</span>
                <span class="tag" data-tag="flow">#flow</span>
                <span class="tag" data-tag="trilingual">#trilingual</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descHybrid">הליכה וריחוף על מים ואוויר עם זרימה מבוקרת</td>
      </tr>

      <tr class="row" data-cat="transport"
          data-key="patent_smart_boarding_token_he.html"
          data-org=""
          data-tags="patent,aviation,token,security,boarding,auth">
        <td class="topic" data-label="נושא">
          <span class="badge b-transport" data-i18n="badgePatent">✈️📄 פטנט — אבטחת תעופה</span>
        </td>
        <td data-label="קישור">
          <div class="fav-wrap">
            <button class="favbtn" type="button" data-fav="patent_smart_boarding_token_he.html" aria-label="Favorite">☆</button>
            <span class="favpill" data-i18n="favPill">⭐ מועדף</span>
            <div>
              <a href="patent_smart_boarding_token_he.html" data-i18n="linkPatent">כרטיס טיסה חכם (Token דינמי) — טיוטת פטנט</a>
              <div class="muted">patent_smart_boarding_token_he.html</div>
              <div class="tagbar">
                <span class="tag" data-tag="patent">#patent</span>
                <span class="tag" data-tag="token">#token</span>
                <span class="tag" data-tag="security">#security</span>
              </div>
            </div>
          </div>
        </td>
        <td class="desc" data-label="תיאור" data-i18n="descPatent">
          מערכת כרטיס טיסה דיגיטלי חכם עם אימות רב־שלבי, Token מתחלף, Anti-Replay וביטול אוטומטי לאחר העלייה למטוס
        </td>
      </tr>

    </tbody>
  </table>

  <footer>
    © כל הזכויות שמורות – קלנסווה<br>
    אין להעתיק, לשכפל, להדפיס, לצלם או לשמור תוכן זה ללא אישור מפורש בכתב
  </footer>

  <!-- Viewer -->
  <div id="viewer" class="viewer" aria-hidden="true">
    <div class="viewer-inner">
      <div class="viewer-bar">
        <button id="viewerClose" class="viewer-btn" type="button" data-i18n="viewerBack">⬅ חזרה למסך המרכזי</button>
        <div class="viewer-title" id="viewerTitle">Preview</div>
        <button id="viewerOpenNew" class="viewer-btn" type="button" data-i18n="viewerNewTab">פתח בלשונית חדשה ↗</button>
      </div>
      <iframe id="viewerFrame" class="viewer-frame" src="" loading="lazy"></iframe>
    </div>
  </div>

  <!-- Graph -->
  <div id="graph" class="graph" aria-hidden="true">
    <div class="graph-inner">
      <div class="graph-bar">
        <button id="graphClose" class="viewer-btn" type="button" data-i18n="graphClose">⬅ חזרה</button>
        <div class="graph-title" data-i18n="graphTitle">מפת קשרים בין רעיונות</div>
        <div class="hint" data-i18n="graphHint">לחיצה על נקודה פותחת את הרעיון ב־Viewer</div>
      </div>
      <canvas id="graphCanvas" class="graph-canvas"></canvas>
    </div>
  </div>

  <script>
    // ⛔ חסימת הדפסה (Ctrl/Cmd+P)
    window.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') {
        e.preventDefault();
        alert('הדפסה חסומה – כל הזכויות שמורות');
      }
    });

    // ⛔ חסימת קליק ימני
    document.addEventListener('contextmenu', e => e.preventDefault());

    // ⛔ חסימת בחירת טקסט
    document.addEventListener('selectstart', e => e.preventDefault());

    // --- Search + Filter + Favorites + Tags + Sort ---
    const searchEl = document.getElementById('search');
    const catEl = document.getElementById('category');
    const organEl = document.getElementById('organ');
    const sortEl = document.getElementById('sort');

    const tbody = document.querySelector('#indexTable tbody');
    const rows = Array.from(document.querySelectorAll('tr.row'));
    const emptyBox = document.getElementById('emptyBox');
    const countAll = document.getElementById('countAll');
    const countShown = document.getElementById('countShown');
    const countFav = document.getElementById('countFav');
    const favOnlyEl = document.getElementById('favOnly');
    const activeTagsRow = document.getElementById('activeTagsRow');

    const LS_KEY = "index_favorites_v2";
    const LS_TAGS = "index_active_tags_v1";
    const LS_SORT = "index_sort_v1";
    const LS_CAT = "index_cat_v1";
    const LS_ORG = "index_org_v1";
    const LS_FAVONLY = "index_favonly_v1";

    function loadFavs(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      }catch(e){
        return new Set();
      }
    }
    function saveFavs(set){
      localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set)));
    }

    function loadActiveTags(){
      try{
        const raw = localStorage.getItem(LS_TAGS);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      }catch(e){
        return new Set();
      }
    }
    function saveActiveTags(set){
      localStorage.setItem(LS_TAGS, JSON.stringify(Array.from(set)));
    }

    let favs = loadFavs();
    let activeTags = loadActiveTags();

    function norm(s){
      return (s || '').toString().toLowerCase().trim();
    }

    function rowTagsSet(r){
      const t = (r.getAttribute('data-tags') || '').split(',').map(x=>norm(x)).filter(Boolean);
      return new Set(t);
    }

    function rowOrgsSet(r){
      const t = (r.getAttribute('data-org') || '').split(',').map(x=>norm(x)).filter(Boolean);
      return new Set(t);
    }

    function syncFavUI(){
      rows.forEach(r=>{
        const key = r.getAttribute('data-key');
        const btn = r.querySelector('button.favbtn');
        const isFav = favs.has(key);
        r.classList.toggle('fav', isFav);
        if(btn){
          btn.classList.toggle('active', isFav);
          btn.textContent = isFav ? '★' : '☆';
          btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
        }
      });
      countFav.textContent = String(favs.size);
    }

    function renderActiveTags(){
      const arr = Array.from(activeTags);
      if(arr.length === 0){
        activeTagsRow.style.display = 'none';
        activeTagsRow.innerHTML = '';
        document.querySelectorAll('.tag').forEach(t=>t.classList.remove('selected'));
        return;
      }

      activeTagsRow.style.display = 'flex';
      activeTagsRow.innerHTML = '';

      arr.forEach(tag=>{
        const pill = document.createElement('span');
        pill.className = 'active-tag';
        pill.innerHTML = `<span>#${tag}</span><button type="button" aria-label="remove">×</button>`;
        pill.querySelector('button').addEventListener('click', ()=>{
          activeTags.delete(tag);
          saveActiveTags(activeTags);
          renderActiveTags();
          apply();
        });
        activeTagsRow.appendChild(pill);
      });

      // highlight selected tags in rows
      document.querySelectorAll('.tag').forEach(el=>{
        const t = norm(el.getAttribute('data-tag'));
        el.classList.toggle('selected', activeTags.has(t));
      });
    }

    function matchesActiveTags(r){
      if(activeTags.size === 0) return true;
      const tset = rowTagsSet(r);
      for(const t of activeTags){
        if(!tset.has(t)) return false;
      }
      return true;
    }

    function apply(){
      const q = norm(searchEl.value);
      const c = catEl.value;
      const o = organEl.value;
      const favOnly = !!favOnlyEl.checked;

      let shown = 0;

      rows.forEach(r=>{
        const rCat = r.getAttribute('data-cat');
        const key = r.getAttribute('data-key');
        const txt = norm(r.innerText);

        const okCat = (c === 'all') || (rCat === c);
        const okQ = (!q) || txt.includes(q) || (r.getAttribute('data-tags') || '').toLowerCase().includes(q) || (r.getAttribute('data-org') || '').toLowerCase().includes(q);
        const okFav = (!favOnly) || favs.has(key);

        let okOrg = true;
        if(o !== 'all'){
          const orgs = rowOrgsSet(r);
          okOrg = orgs.has(norm(o));
        }

        const okTags = matchesActiveTags(r);

        const ok = okCat && okQ && okFav && okOrg && okTags;
        r.style.display = ok ? '' : 'none';
        if(ok) shown++;
      });

      countShown.textContent = String(shown);
      emptyBox.style.display = (shown === 0) ? 'block' : 'none';

      // after filter, apply sort (stable)
      applySort();
    }

    // Sort: rearrange DOM
    const originalOrder = rows.slice(); // keep reference order

    function getTitleText(r){
      const a = r.querySelector('a');
      return norm(a ? a.textContent : '');
    }

    function applySort(){
      const mode = sortEl.value || 'default';
      localStorage.setItem(LS_SORT, mode);

      let list = rows.slice();

      if(mode === 'default'){
        list = originalOrder.slice();
      } else if(mode === 'title'){
        list.sort((a,b)=> getTitleText(a).localeCompare(getTitleText(b)));
      } else if(mode === 'file'){
        list.sort((a,b)=> norm(a.dataset.key).localeCompare(norm(b.dataset.key)));
      } else if(mode === 'favFirst'){
        list.sort((a,b)=>{
          const af = favs.has(a.dataset.key) ? 1 : 0;
          const bf = favs.has(b.dataset.key) ? 1 : 0;
          if(af !== bf) return bf - af;
          return getTitleText(a).localeCompare(getTitleText(b));
        });
      }

      // only reorder visible+hidden in DOM; visibility preserved
      const frag = document.createDocumentFragment();
      list.forEach(r=>frag.appendChild(r));
      tbody.appendChild(frag);
    }

    // init counts
    countAll.textContent = String(rows.length);

    // favorite button handlers
    document.querySelectorAll('button.favbtn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const key = btn.getAttribute('data-fav');
        if(!key) return;
        if(favs.has(key)) favs.delete(key);
        else favs.add(key);
        saveFavs(favs);
        syncFavUI();
        apply();
      });
    });

    // tag click handlers (multi-select)
    document.querySelectorAll('.tag').forEach(tagEl=>{
      tagEl.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const t = norm(tagEl.getAttribute('data-tag'));
        if(!t) return;
        if(activeTags.has(t)) activeTags.delete(t);
        else activeTags.add(t);
        saveActiveTags(activeTags);
        renderActiveTags();
        apply();
      });
    });

    searchEl.addEventListener('input', apply);
    catEl.addEventListener('change', ()=>{ localStorage.setItem(LS_CAT, catEl.value); apply(); });
    organEl.addEventListener('change', ()=>{ localStorage.setItem(LS_ORG, organEl.value); apply(); });
    favOnlyEl.addEventListener('change', ()=>{ localStorage.setItem(LS_FAVONLY, favOnlyEl.checked ? '1':'0'); apply(); });
    sortEl.addEventListener('change', apply);

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      searchEl.value = '';
      catEl.value = 'all';
      organEl.value = 'all';
      favOnlyEl.checked = false;
      activeTags = new Set();
      saveActiveTags(activeTags);
      renderActiveTags();
      apply();
    });

    document.getElementById('clearFavBtn').addEventListener('click', ()=>{
      if(favs.size === 0) return;
      favs = new Set();
      saveFavs(favs);
      syncFavUI();
      apply();
    });

    // ===== ✅ Viewer (Back to home without editing other files) =====
    const viewer = document.getElementById('viewer');
    const viewerFrame = document.getElementById('viewerFrame');
    const viewerClose = document.getElementById('viewerClose');
    const viewerTitle = document.getElementById('viewerTitle');
    const viewerOpenNew = document.getElementById('viewerOpenNew');
    let lastHref = "";

    function openViewer(href, titleText){
      lastHref = href;
      viewerTitle.textContent = titleText || href;
      viewerFrame.src = href;
      viewer.classList.add('open');
      viewer.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeViewer(){
      viewer.classList.remove('open');
      viewer.setAttribute('aria-hidden', 'true');
      viewerFrame.src = "";
      document.body.style.overflow = '';
    }

    viewerClose.addEventListener('click', closeViewer);
    viewer.addEventListener('click', (e)=>{ if(e.target === viewer) closeViewer(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && viewer.classList.contains('open')) closeViewer(); });
    viewerOpenNew.addEventListener('click', ()=>{ if(lastHref) window.open(lastHref, '_blank'); });

    // intercept table link clicks -> open in viewer
    function bindLinkInterception(){
      document.querySelectorAll('#indexTable tbody a').forEach(a=>{
        a.addEventListener('click', (e)=>{
          if(e.ctrlKey || e.metaKey || e.shiftKey || e.button === 1) return;
          e.preventDefault();
          const href = a.getAttribute('href');
          const txt = a.textContent.trim();
          openViewer(href, txt);
        });
      });
    }
    bindLinkInterception();

    document.getElementById('openAllBtn').addEventListener('click', ()=>{
      const visibleLinks = rows
        .filter(r => r.style.display !== 'none')
        .map(r => r.querySelector('a'))
        .filter(Boolean);

      if(!visibleLinks.length){
        alert(window.__i18nLang === 'en' ? 'No links to open for current filters.' :
              window.__i18nLang === 'ar' ? 'لا توجد روابط لفتحها وفق التصفية الحالية.' :
              window.__i18nLang === 'ru' ? 'Нет ссылок для открытия при текущих фильтрах.' :
              'אין קישורים פתוחים לפי הסינון הנוכחי.');
        return;
      }
      openViewer(visibleLinks[0].getAttribute('href'), visibleLinks[0].textContent.trim());
    });

    // Open all tabs (popup may block)
    document.getElementById('openAllTabsBtn').addEventListener('click', ()=>{
      const visibleLinks = rows
        .filter(r => r.style.display !== 'none')
        .map(r => r.querySelector('a'))
        .filter(Boolean);

      if(!visibleLinks.length){
        alert(window.__i18nLang === 'en' ? 'No links to open for current filters.' :
              window.__i18nLang === 'ar' ? 'لا توجد روابط لفتحها وفق التصفية الحالية.' :
              window.__i18nLang === 'ru' ? 'Нет ссылок для открытия при текущих фильтрах.' :
              'אין קישורים פתוחים לפי הסינון הנוכחי.');
        return;
      }

      const msg =
        window.__i18nLang === 'en' ? `Open ${visibleLinks.length} tabs? Your browser may block popups.` :
        window.__i18nLang === 'ar' ? `فتح ${visibleLinks.length} علامات تبويب؟ قد يمنع المتصفح النوافذ المنبثقة.` :
        window.__i18nLang === 'ru' ? `Открыть ${visibleLinks.length} вкладок? Браузер может заблокировать всплывающие окна.` :
        `לפתוח ${visibleLinks.length} לשוניות? ייתכן שהדפדפן יחסום חלונות קופצים.`;

      if(!confirm(msg)) return;

      visibleLinks.forEach(a=>{
        window.open(a.getAttribute('href'), '_blank');
      });
    });

    // --- i18n ---
    const dict = {
      he:{
        pageTitle:"דף הבית",
        welcome:"ברוכים הבאים",
        summaryPrefix:"סך הכל קבצים:",
        summaryShown:"מוצגים כעת:",
        summaryFav:"מועדפים:",
        searchLabel:"חיפוש",
        searchPh:"הקלד מילה/שם קובץ/תיאור/תגית…",
        searchHint:"מחפש בתוך נושא, שם קובץ, תיאור, תגיות ואיברים.",
        filterLabel:"סינון לפי קטגוריה",
        filterAll:"הכל",
        catNet:"תקשורת ורשתות",
        catUi:"ממשק אדם–מסך",
        catId:"זיהוי זהות",
        catMed:"רפואה חכמה",
        catBio:"מודלים ביולוגיים",
        catElec:"חשמל וסימולציות",
        catThermo:"תרמודינמיקה",
        catAudio:"אנרגיה וקול",
        catFloor:"אנרגיה מהרצפה",
        catWater:"תנועה על מים",
        catTransport:"תחבורה",
        catHybrid:"הנעה היברידית",

        organLabel:"סינון לפי איבר",
        organAll:"הכל",
        organPancreas:"לבלב",
        organLiver:"כבד",
        organKidney:"כליות",
        organHeart:"לב",
        organLung:"ריאות",
        organSpleen:"טחול",
        organBlood:"דם",
        organAir:"אוויר/נשימה",
        organSkin:"עור",

        sortLabel:"מיון",
        sortDefault:"ברירת מחדל",
        sortTitle:"לפי כותרת",
        sortFile:"לפי שם קובץ",
        sortFavFirst:"מועדפים בראש",

        resetBtn:"איפוס",
        openAllBtn:"פתח קישור ראשון (ב־Viewer)",
        openAllTabsBtn:"פתח את כולם בלשוניות",
        clearFavBtn:"נקה מועדפים",
        graphBtn:"מפת קשרים (Graph)",

        favOnlyLabel:"תצוגה",
        favOnlyText:"הצג מועדפים בלבד",
        favHint:"הכוכב נשמר בדפדפן (LocalStorage).",
        favPill:"⭐ מועדף",
        empty:"לא נמצאו תוצאות. נסה לשנות את החיפוש או לבחור קטגוריה/איבר אחרת.",

        thTopic:"נושא",
        thLink:"שם הקובץ / קישור",
        thDesc:"תיאור",

        viewerBack:"⬅ חזרה למסך המרכזי",
        viewerNewTab:"פתח בלשונית חדשה ↗",

        graphClose:"⬅ חזרה",
        graphTitle:"מפת קשרים בין רעיונות",
        graphHint:"לחיצה על נקודה פותחת את הרעיון ב־Viewer",

        badgeNet:"🌐🔌 תקשורת ורשתות",
        badgeUi:"🖐️📺 ממשק אדם–מסך",
        badgeId:"📱🌍 זיהוי זהות רב־לשוני",
        badgeMed:"🧬🧲 רפואה חכמה",
        badgeElec:"⚡ חשמל וסימולציות",
        badgeThermo:"🔥 תרמודינמיקה",
        badgeAudio:"🎧 אנרגיה וקול",
        badgeFloor:"🧱⚡ אנרגיה מהרצפה",
        badgeWater:"🌊👟 תנועה על מים",
        badgeTransport:"🚆💧 תנועה ותחבורה",
        badgeHybrid:"🌊🌬️ הנעה היברידית",

        linkUsb:"USB + רשת (OSI + IPv6)",
        descUsb:"חיבור USB כרשת מלאה לפי מודל 7 השכבות, כולל IPv4/IPv6, תרשים חומרה ותרחיש שימוש מעשי",

        linkFp:"מסכים חכמים לפי טביעת אצבע",
        descFp:"מערכת מסכים אינטראקטיבית המגיבה לטביעת אצבע ומחוות, כולל אימות משתמש, אלגוריתמים ודמו מלא",

        badgeLightBio:"💡🖐️ תאורה חכמה ביומטרית",
        linkLightBio:"תאורה ללא מפסיקים — הצבעה + טביעת אצבע",
        descLightBio:"דף מערכת מלא: ארכיטקטורה, תרשימים, אבטחה, סימולציה ופרוטוטייפ להפעלת נר/תאורה בהצבעה ואימות ביומטרי",

        linkBivdn:"BIVDN – זיהוי זהות נייד",
        descBivdn:"מערכת זיהוי דיגיטלית רב־לשונית למובייל: אימות זהות, ממשק רספונסיבי, תמיכה בשפות מרובות והתאמה למסכים קטנים",

        linkBio:"מגנט ביולוגי להולכת תרופות",
        descBio:"מודל מחקרי להחלפת אינפוזיה: טלאי חכם המבוסס על DNA, חתימה חשמלית וניווט טיפולי (\"GPS ביולוגי\") בגוף האדם",

        badgePlantOil:"🌱🛢️ גזים → נפט ביולוגי",
        linkPlantOil:"המרת גזים מצמחים לנפט ביולוגי (MVP)",
        descPlantOil:"מודל MVP להפקת נפט ביולוגי מגזים הנפלטים מצמחים בחללים סגורים: לכידה, פירוק, תהליך חום ויישום עירוני.",

        badgeCleanAir:"🧼🫁 אזור אוויר נקי",
        linkCleanAir:"פטנט: אזור אוויר נקי ריבועי (Clean-Air Zone)",
        descCleanAir:"יצירת “בועת” אוויר נקי ריבועית סביב מטופל/אזור מוגדר באמצעות אספקת אוויר, פיזור מבוקר וניטור חלקיקים/מזהמים.",

        badgeMetabolicRail:"🚆🧬 מודל רכבת מטבולית",
        linkMetabolicRail:"מודל רכבת מטבולית – ויסות חומרים בגוף",
        descMetabolicRail:"מודל ביולוגי־מערכתי: הלבלב כתחנת מקור מרכזית, והאיברים כתחנות “רכבת” מטבוליות לפירוק/ויסות והזרמת סוכר, נוזלים וחומרים – לשמירה על איזון פנימי.",

        linkElec:"מודל חשמל + סימולציות",
        descElec:"מודלים פיזיקליים, משוואות וסימולציות אינטראקטיביות",

        linkThermo:"תרמוסיפון",
        descThermo:"מחשבון זרימה תרמוסיפונית לפי פרמטרים פיזיקליים",

        linkAudio:"אוזניות נטענות מעצמן",
        descAudio:"טעינה עצמית מאנרגיית קול – מודל תאורטי וסימולציה",

        linkFloor:"מודל רצפה חכמה",
        descFloor:"הפקת אנרגיה מלחץ ומיפוי עומסים",

        linkWater:"נעליים להליכה על מים",
        descWater:"סונאר, משאבות זעירות ושיווי־משקל דינמי",

        linkTrain:"רכבת מים–גז (Blue)",
        descTrain:"תחבורה מבוססת מים וגז עם יעילות אנרגטית",

        linkHybrid:"נעליים מים–אוויר (תלת־לשוני)",
        descHybrid:"הליכה וריחוף על מים ואוויר עם זרימה מבוקרת",

        badgePatent:"✈️📄 פטנט — אבטחת תעופה",
        linkPatent:"כרטיס טיסה חכם (Token דינמי) — טיוטת פטנט",
        descPatent:"מערכת כרטיס טיסה דיגיטלי חכם עם אימות רב־שלבי, Token מתחלף, Anti-Replay וביטול אוטומטי לאחר העלייה למטוס",
      },

      en:{
        pageTitle:"Home",
        welcome:"Welcome",
        summaryPrefix:"Total files:",
        summaryShown:"Shown now:",
        summaryFav:"Favorites:",
        searchLabel:"Search",
        searchPh:"Type keyword / filename / description / tag…",
        searchHint:"Searches topic, filename, description, tags and organs.",
        filterLabel:"Filter by category",
        filterAll:"All",
        catNet:"Networking & Communications",
        catUi:"Human–Screen Interface",
        catId:"Identity",
        catMed:"Smart Medicine",
        catBio:"Biological Models",
        catElec:"Electricity & Simulations",
        catThermo:"Thermodynamics",
        catAudio:"Sound & Energy",
        catFloor:"Energy from Floors",
        catWater:"Water Mobility",
        catTransport:"Transport",
        catHybrid:"Hybrid Propulsion",

        organLabel:"Filter by organ",
        organAll:"All",
        organPancreas:"Pancreas",
        organLiver:"Liver",
        organKidney:"Kidneys",
        organHeart:"Heart",
        organLung:"Lungs",
        organSpleen:"Spleen",
        organBlood:"Blood",
        organAir:"Air/Breathing",
        organSkin:"Skin",

        sortLabel:"Sort",
        sortDefault:"Default",
        sortTitle:"By title",
        sortFile:"By filename",
        sortFavFirst:"Favorites first",

        resetBtn:"Reset",
        openAllBtn:"Open first link (Viewer)",
        openAllTabsBtn:"Open all in tabs",
        clearFavBtn:"Clear favorites",
        graphBtn:"Connections map (Graph)",

        favOnlyLabel:"View",
        favOnlyText:"Show favorites only",
        favHint:"Stars are saved in the browser (LocalStorage).",
        favPill:"⭐ Favorite",
        empty:"No results found. Try changing the search or category/organ.",

        thTopic:"Topic",
        thLink:"File / Link",
        thDesc:"Description",

        viewerBack:"⬅ Back to home",
        viewerNewTab:"Open in new tab ↗",

        graphClose:"⬅ Back",
        graphTitle:"Idea connections map",
        graphHint:"Click a node to open it in the Viewer",

        badgeNet:"🌐🔌 Networking & Communications",
        badgeUi:"🖐️📺 Human–Screen Interface",
        badgeId:"📱🌍 Multilingual Identity",
        badgeMed:"🧬🧲 Smart Medicine",
        badgeElec:"⚡ Electricity & Simulations",
        badgeThermo:"🔥 Thermodynamics",
        badgeAudio:"🎧 Sound & Energy",
        badgeFloor:"🧱⚡ Energy from Floors",
        badgeWater:"🌊👟 Water Mobility",
        badgeTransport:"🚆💧 Transport",
        badgeHybrid:"🌊🌬️ Hybrid Propulsion",

        linkUsb:"USB + Network (OSI + IPv6)",
        descUsb:"USB as a full network stack (OSI layers), including IPv4/IPv6, hardware diagram and a practical use-case.",

        linkFp:"Fingerprint-Gesture Smart Screens",
        descFp:"Interactive screen system driven by fingerprint + gestures, including authentication, algorithms and a full demo.",

        badgeLightBio:"💡🖐️ Biometric Smart Lighting",
        linkLightBio:"No-Switch Lighting — Pointing + Fingerprint",
        descLightBio:"Full system page: architecture, diagrams, security, simulation and prototype for pointing-based lighting with biometric authentication.",

        linkBivdn:"BIVDN – Mobile Identity",
        descBivdn:"Multilingual digital identity for mobile: verification, responsive UI, multi-language support, small-screen optimized.",

        linkBio:"Bio-Magnet Drug Delivery",
        descBio:"Research concept to reduce IV infusion: smart patch based on DNA, electrical signature and therapeutic navigation (\"biological GPS\").",

        badgePlantOil:"🌱🛢️ Gases → Bio-Oil",
        linkPlantOil:"Plant Gas to Bio-Oil (MVP)",
        descPlantOil:"MVP model for producing bio-oil from gases emitted by plants in indoor spaces: capture, conversion, thermal process and urban application.",

        badgeCleanAir:"🧼🫁 Clean-Air Zone",
        linkCleanAir:"Patent: Square Clean-Air Zone",
        descCleanAir:"Creating a square clean-air “bubble” around a patient/defined area using airflow supply, controlled dispersion, and particle/pollutant monitoring.",

        badgeMetabolicRail:"🚆🧬 Metabolic Railway Model",
        linkMetabolicRail:"Metabolic Railway – Body Regulation Model",
        descMetabolicRail:"System-level biology model: pancreas as a central source station; organs as “metabolic stations” to regulate breakdown, glucose and fluids to maintain homeostasis.",

        linkElec:"Electricity Models + Simulations",
        descElec:"Physical models, equations and interactive simulations.",

        linkThermo:"Thermosiphon",
        descThermo:"Thermosiphon flow calculator based on physical parameters.",

        linkAudio:"Self-Charging Headphones",
        descAudio:"Self charging from sound energy – theoretical model and simulation.",

        linkFloor:"Smart Floor Model",
        descFloor:"Energy harvesting from pressure and load mapping.",

        linkWater:"Water-Walking Shoes",
        descWater:"Sonar, micro-pumps and dynamic balance.",

        linkTrain:"Water–Gas Train (Blue)",
        descTrain:"Transport concept based on water and gas with energy efficiency.",

        linkHybrid:"Water–Air Shoes (Trilingual)",
        descHybrid:"Walking/hovering on water and air with controlled flow.",

        badgePatent:"✈️📄 Patent — Aviation Security",
        linkPatent:"Smart Boarding Pass (Dynamic Token) — Patent Draft",
        descPatent:"A smart digital boarding pass with multi-step verification, rolling token, anti-replay and automatic revocation after boarding."
      },

      ar:{
        pageTitle:"الصفحة الرئيسية",
        welcome:"مرحباً",
        summaryPrefix:"إجمالي الملفات:",
        summaryShown:"المعروض الآن:",
        summaryFav:"المفضلة:",
        searchLabel:"بحث",
        searchPh:"اكتب كلمة / اسم ملف / وصف / وسم…",
        searchHint:"يبحث داخل العنوان واسم الملف والوصف والوسوم والأعضاء.",
        filterLabel:"تصفية حسب الفئة",
        filterAll:"الكل",
        catNet:"الشبكات والاتصالات",
        catUi:"واجهة الإنسان–الشاشة",
        catId:"الهوية",
        catMed:"طب ذكي",
        catBio:"نماذج بيولوجية",
        catElec:"الكهرباء والمحاكاة",
        catThermo:"الديناميكا الحرارية",
        catAudio:"الصوت والطاقة",
        catFloor:"طاقة من الأرضيات",
        catWater:"حركة على الماء",
        catTransport:"النقل",
        catHybrid:"دفع هجين",

        organLabel:"تصفية حسب العضو",
        organAll:"الكل",
        organPancreas:"البنكرياس",
        organLiver:"الكبد",
        organKidney:"الكلى",
        organHeart:"القلب",
        organLung:"الرئتان",
        organSpleen:"الطحال",
        organBlood:"الدم",
        organAir:"الهواء/التنفس",
        organSkin:"الجلد",

        sortLabel:"فرز",
        sortDefault:"افتراضي",
        sortTitle:"حسب العنوان",
        sortFile:"حسب اسم الملف",
        sortFavFirst:"المفضلة أولاً",

        resetBtn:"إعادة ضبط",
        openAllBtn:"افتح أول رابط (Viewer)",
        openAllTabsBtn:"افتح الكل في تبويبات",
        clearFavBtn:"مسح المفضلة",
        graphBtn:"خريطة العلاقات (Graph)",

        favOnlyLabel:"عرض",
        favOnlyText:"عرض المفضلة فقط",
        favHint:"يتم حفظ النجمة في المتصفح (LocalStorage).",
        favPill:"⭐ مفضّل",
        empty:"لا توجد نتائج. جرّب تغيير البحث أو الفئة/العضو.",

        thTopic:"الموضوع",
        thLink:"الملف / الرابط",
        thDesc:"الوصف",

        viewerBack:"⬅ رجوع إلى الرئيسية",
        viewerNewTab:"افتح في تبويب جديد ↗",

        graphClose:"⬅ رجوع",
        graphTitle:"خريطة العلاقات بين الأفكار",
        graphHint:"اضغط على النقطة لفتحها في Viewer",

        badgeNet:"🌐🔌 الشبكات والاتصالات",
        badgeUi:"🖐️📺 واجهة الإنسان–الشاشة",
        badgeId:"📱🌍 هوية متعددة اللغات",
        badgeMed:"🧬🧲 طب ذكي",
        badgeElec:"⚡ الكهرباء والمحاكاة",
        badgeThermo:"🔥 الديناميكا الحرارية",
        badgeAudio:"🎧 الصوت والطاقة",
        badgeFloor:"🧱⚡ طاقة من الأرضيات",
        badgeWater:"🌊👟 حركة على الماء",
        badgeTransport:"🚆💧 النقل",
        badgeHybrid:"🌊🌬️ دفع هجين",

        linkUsb:"USB + شبكة (OSI + IPv6)",
        descUsb:"USB كنظام شبكة كامل (طبقات OSI) مع IPv4/IPv6 ومخطط عتاد وسيناريو عملي.",
        linkFp:"شاشات ذكية ببصمة وإيماءات",
        descFp:"نظام شاشات تفاعلي يعتمد على البصمة والإيماءات مع التحقق والخوارزميات وعرض كامل.",
        badgeLightBio:"💡🖐️ إضاءة ذكية بيومترية",
        linkLightBio:"إضاءة بدون مفاتيح — الإشارة + بصمة",
        descLightBio:"صفحة نظام كاملة: بنية، مخططات، أمان، محاكاة ونموذج أولي لتشغيل الإضاءة بالإشارة مع تحقق بيومتري.",
        linkBivdn:"BIVDN – هوية محمولة",
        descBivdn:"هوية رقمية متعددة اللغات للموبايل: تحقق، واجهة متجاوبة، دعم لغات متعددة، مناسبة للشاشات الصغيرة.",
        linkBio:"مغناطيس حيوي لإيصال الدواء",
        descBio:"فكرة بحثية لتقليل التسريب الوريدي: رقعة ذكية تعتمد على DNA وتوقيع كهربائي وتوجيه علاجي (\"GPS\" حيوي).",

        badgePlantOil:"🌱🛢️ غازات → نفط حيوي",
        linkPlantOil:"تحويل غازات النباتات إلى نفط حيوي (MVP)",
        descPlantOil:"نموذج MVP لإنتاج نفط حيوي من غازات تنبعث من النباتات في أماكن مغلقة: التقاط، تحويل، عملية حرارية وتطبيق حضري.",

        badgeCleanAir:"🧼🫁 منطقة هواء نظيف",
        linkCleanAir:"براءة: منطقة هواء نظيف مربعة",
        descCleanAir:"إنشاء “فقاعة” هواء نظيف مربعة حول المريض/منطقة محددة عبر تزويد الهواء، توزيع مضبوط، ومراقبة الجسيمات/الملوثات.",

        badgeMetabolicRail:"🚆🧬 نموذج سكة حديد أيضية",
        linkMetabolicRail:"السكة الأيضية – نموذج تنظيم الجسم",
        descMetabolicRail:"نموذج منظومي: البنكرياس كمحطة مصدر مركزية، والأعضاء كمحطات أيضية لتنظيم تفكيك المواد والغلوكوز والسوائل للحفاظ على الاتزان الداخلي.",

        linkElec:"نماذج كهرباء + محاكاة",
        descElec:"نماذج فيزيائية ومعادلات ومحاكاة تفاعلية.",
        linkThermo:"الثرموسيفون",
        descThermo:"حاسبة تدفق ثرموسيفون وفق المعلمات الفيزيائية.",
        linkAudio:"سماعات تشحن نفسها",
        descAudio:"شحن ذاتي من طاقة الصوت – نموذج نظري ومحاكاة.",
        linkFloor:"نموذج أرضية ذكية",
        descFloor:"توليد طاقة من الضغط ورسم خرائط الأحمال.",
        linkWater:"أحذية للمشي على الماء",
        descWater:"سونار ومضخات دقيقة وتوازن ديناميكي.",
        linkTrain:"قطار ماء–غاز (Blue)",
        descTrain:"مفهوم نقل يعتمد الماء والغاز بكفاءة طاقية.",
        linkHybrid:"أحذية ماء–هواء (ثلاثي اللغة)",
        descHybrid:"المشي/التحليق على الماء والهواء بتدفق مُتحكم به.",
        badgePatent:"✈️📄 براءة — أمن الطيران",
        linkPatent:"بطاقة صعود ذكية (Token ديناميكي) — مسودة براءة",
        descPatent:"بطاقة صعود رقمية ذكية مع تحقق متعدد المراحل، Token متغير، منع إعادة الاستخدام وإلغاء تلقائي بعد الصعود."
      },

      ru:{
        pageTitle:"Главная",
        welcome:"Добро пожаловать",
        summaryPrefix:"Всего файлов:",
        summaryShown:"Показано сейчас:",
        summaryFav:"Избранное:",
        searchLabel:"Поиск",
        searchPh:"Введите слово / имя файла / описание / тег…",
        searchHint:"Поиск по теме, имени файла, описанию, тегам и органам.",
        filterLabel:"Фильтр по категории",
        filterAll:"Все",
        catNet:"Сети и связь",
        catUi:"Интерфейс человек–экран",
        catId:"Идентификация",
        catMed:"Умная медицина",
        catBio:"Биологические модели",
        catElec:"Электричество и симуляции",
        catThermo:"Термодинамика",
        catAudio:"Звук и энергия",
        catFloor:"Энергия от пола",
        catWater:"Движение по воде",
        catTransport:"Транспорт",
        catHybrid:"Гибридная тяга",

        organLabel:"Фильтр по органу",
        organAll:"Все",
        organPancreas:"Поджелудочная",
        organLiver:"Печень",
        organKidney:"Почки",
        organHeart:"Сердце",
        organLung:"Лёгкие",
        organSpleen:"Селезёнка",
        organBlood:"Кровь",
        organAir:"Воздух/дыхание",
        organSkin:"Кожа",

        sortLabel:"Сортировка",
        sortDefault:"По умолчанию",
        sortTitle:"По заголовку",
        sortFile:"По имени файла",
        sortFavFirst:"Избранное сверху",

        resetBtn:"Сброс",
        openAllBtn:"Открыть первую ссылку (Viewer)",
        openAllTabsBtn:"Открыть всё во вкладках",
        clearFavBtn:"Очистить избранное",
        graphBtn:"Карта связей (Graph)",

        favOnlyLabel:"Вид",
        favOnlyText:"Показывать только избранное",
        favHint:"Звёздочки сохраняются в браузере (LocalStorage).",
        favPill:"⭐ Избранное",
        empty:"Ничего не найдено. Попробуйте изменить поиск или категорию/орган.",

        thTopic:"Тема",
        thLink:"Файл / Ссылка",
        thDesc:"Описание",

        viewerBack:"⬅ Назад на главную",
        viewerNewTab:"Открыть в новой вкладке ↗",

        graphClose:"⬅ Назад",
        graphTitle:"Карта связей идей",
        graphHint:"Нажмите на узел, чтобы открыть его в Viewer",

        badgeNet:"🌐🔌 Сети и связь",
        badgeUi:"🖐️📺 Интерфейс человек–экран",
        badgeId:"📱🌍 Многоязычная идентификация",
        badgeMed:"🧬🧲 Умная медицина",
        badgeElec:"⚡ Электричество и симуляции",
        badgeThermo:"🔥 Термодинамика",
        badgeAudio:"🎧 Звук и энергия",
        badgeFloor:"🧱⚡ Энергия от пола",
        badgeWater:"🌊👟 Движение по воде",
        badgeTransport:"🚆💧 Транспорт",
        badgeHybrid:"🌊🌬️ Гибридная тяга",

        linkUsb:"USB + сеть (OSI + IPv6)",
        descUsb:"USB как полноценная сеть (уровни OSI), включая IPv4/IPv6, схема железа и практический сценарий.",
        linkFp:"Умные экраны по отпечатку и жестам",
        descFp:"Интерактивная система экранов: отпечаток + жесты, аутентификация, алгоритмы и полный демо-режим.",
        badgeLightBio:"💡🖐️ Биометрическое умное освещение",
        linkLightBio:"Освещение без выключателей — указание + отпечаток",
        descLightBio:"Полная страница системы: архитектура, схемы, безопасность, симуляция и прототип управления светом по указанию с биометрической проверкой.",
        linkBivdn:"BIVDN – мобильная идентификация",
        descBivdn:"Многоязычная цифровая идентификация для мобильных: проверка, адаптивный интерфейс, поддержка языков, оптимизация для маленьких экранов.",
        linkBio:"Био-магнитная доставка лекарств",
        descBio:"Исследовательская концепция: умный пластырь на основе ДНК, электрической подписи и терапевтической навигации (\"био-GPS\").",

        badgePlantOil:"🌱🛢️ Газы → Био-нефть",
        linkPlantOil:"Газы растений в био-нефть (MVP)",
        descPlantOil:"MVP-модель получения био-нефти из газов, выделяемых растениями в помещениях: захват, преобразование, тепловой процесс и городской сценарий.",

        badgeCleanAir:"🧼🫁 Зона чистого воздуха",
        linkCleanAir:"Патент: квадратная зона чистого воздуха",
        descCleanAir:"Создание квадратного «пузыря» чистого воздуха вокруг пациента/заданной зоны за счёт подачи воздуха, управляемого распределения и мониторинга частиц/загрязнений.",

        badgeMetabolicRail:"🚆🧬 Модель метаболической железной дороги",
        linkMetabolicRail:"Метаболическая железная дорога — модель регуляции",
        descMetabolicRail:"Системная модель: поджелудочная как центральная станция источника; органы как «метаболические станции» для регуляции распада, глюкозы и жидкостей (гомеостаз).",

        linkElec:"Модели электричества + симуляции",
        descElec:"Физические модели, уравнения и интерактивные симуляции.",
        linkThermo:"Термосифон",
        descThermo:"Калькулятор потока термосифона по физическим параметрам.",
        linkAudio:"Самозаряжающиеся наушники",
        descAudio:"Самозаряд от энергии звука — теоретическая модель и симуляция.",
        linkFloor:"Модель умного пола",
        descFloor:"Сбор энергии от давления и карта нагрузок.",
        linkWater:"Обувь для ходьбы по воде",
        descWater:"Сонар, микропомпы и динамическая устойчивость.",
        linkTrain:"Поезд вода–газ (Blue)",
        descTrain:"Транспортная концепция на воде и газе с повышенной энергоэффективностью.",
        linkHybrid:"Обувь вода–воздух (трёхъязычная)",
        descHybrid:"Ходьба/парение по воде и воздуху с управляемым потоком.",
        badgePatent:"✈️📄 Патент — авиационная безопасность",
        linkPatent:"Умный посадочный талон (динамический Token) — черновик патента",
        descPatent:"Умный посадочный талон: многоэтапная проверка, меняющийся токен, anti-replay и автоматическая аннуляция после посадки."
      }
    };

    function setLang(lang){
      const L = dict[lang] ? lang : "he";
      const root = document.documentElement;
      window.__i18nLang = L;

      if(L === "en" || L === "ru"){
        root.lang = L;
        root.dir = "ltr";
      } else if(L === "ar"){
        root.lang = "ar";
        root.dir = "rtl";
      } else {
        root.lang = "he";
        root.dir = "rtl";
      }

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if(dict[L][key] !== undefined){
          el.textContent = dict[L][key];
        }
      });

      document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
        const key = el.getAttribute("data-i18n-ph");
        if(dict[L][key] !== undefined){
          el.setAttribute("placeholder", dict[L][key]);
        }
      });

      document.querySelectorAll("option[data-i18n]").forEach(opt=>{
        const key = opt.getAttribute("data-i18n");
        if(dict[L][key] !== undefined){
          opt.textContent = dict[L][key];
        }
      });

      document.querySelectorAll(".langbtn").forEach(btn=>{
        btn.classList.toggle("active", btn.getAttribute("data-lang") === L);
      });

      apply();
    }

    document.querySelectorAll(".langbtn").forEach(btn=>{
      btn.addEventListener("click", ()=> setLang(btn.getAttribute("data-lang")));
    });

    // restore last settings
    (function restore(){
      try{
        const s = localStorage.getItem(LS_SORT);
        if(s) sortEl.value = s;
        const c = localStorage.getItem(LS_CAT);
        if(c) catEl.value = c;
        const o = localStorage.getItem(LS_ORG);
        if(o) organEl.value = o;
        const f = localStorage.getItem(LS_FAVONLY);
        if(f) favOnlyEl.checked = (f === '1');
      }catch(e){}
    })();

    // ===== Graph (connections) =====
    const graph = document.getElementById('graph');
    const graphBtn = document.getElementById('graphBtn');
    const graphClose = document.getElementById('graphClose');
    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function buildNodes(){
      const visible = rows.filter(r=>r.style.display !== 'none');
      const list = (visible.length ? visible : rows);

      return list.map((r,i)=>{
        const a = r.querySelector('a');
        const title = (a ? a.textContent.trim() : r.dataset.key);
        return {
          id: r.dataset.key,
          title,
          href: a ? a.getAttribute('href') : '',
          cat: r.dataset.cat,
          tags: Array.from(rowTagsSet(r)),
          orgs: Array.from(rowOrgsSet(r)),
          x: 80 + (i*40) % 400,
          y: 80 + Math.floor((i*40)/400)*50,
          vx: 0,
          vy: 0
        };
      });
    }

    function buildEdges(nodes){
      const byId = new Map(nodes.map(n=>[n.id,n]));
      const edges = [];
      for(let i=0;i<nodes.length;i++){
        for(let j=i+1;j<nodes.length;j++){
          const a = nodes[i], b = nodes[j];
          let w = 0;

          if(a.cat === b.cat) w += 2;

          const at = new Set(a.tags);
          b.tags.forEach(t=>{ if(at.has(t)) w += 1; });

          const ao = new Set(a.orgs);
          b.orgs.forEach(o=>{ if(ao.has(o)) w += 1; });

          // edge if strong enough
          if(w >= 3){
            edges.push({a:a.id, b:b.id, w});
          }
        }
      }
      return edges.map(e=>({na:byId.get(e.a), nb:byId.get(e.b), w:e.w})).filter(e=>e.na && e.nb);
    }

    function drawGraph(nodes, edges){
      resizeCanvas();
      const W = canvas.getBoundingClientRect().width;
      const H = canvas.getBoundingClientRect().height;

      // simple force layout (few iterations)
      for(let step=0; step<180; step++){
        // repulsion
        for(let i=0;i<nodes.length;i++){
          for(let j=i+1;j<nodes.length;j++){
            const a = nodes[i], b = nodes[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const d2 = dx*dx + dy*dy + 0.01;
            const f = 1200 / d2;
            const fx = f * dx;
            const fy = f * dy;
            a.vx += fx; a.vy += fy;
            b.vx -= fx; b.vy -= fy;
          }
        }

        // attraction along edges
        edges.forEach(e=>{
          const a = e.na, b = e.nb;
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const dist = Math.sqrt(dx*dx + dy*dy) + 0.01;
          const k = 0.0025 * e.w;
          const fx = k * dx * dist;
          const fy = k * dy * dist;
          a.vx += fx; a.vy += fy;
          b.vx -= fx; b.vy -= fy;
        });

        // integrate & clamp
        nodes.forEach(n=>{
          n.vx *= 0.88;
          n.vy *= 0.88;
          n.x += n.vx * 0.01;
          n.y += n.vy * 0.01;
          n.x = Math.max(30, Math.min(W-30, n.x));
          n.y = Math.max(30, Math.min(H-30, n.y));
        });
      }

      // clear
      ctx.clearRect(0,0,W,H);

      // edges
      ctx.lineWidth = 1;
      edges.forEach(e=>{
        ctx.globalAlpha = Math.min(0.75, 0.15 + e.w*0.12);
        ctx.beginPath();
        ctx.moveTo(e.na.x, e.na.y);
        ctx.lineTo(e.nb.x, e.nb.y);
        ctx.strokeStyle = "#94a3b8";
        ctx.stroke();
      });
      ctx.globalAlpha = 1;

      // nodes
      nodes.forEach(n=>{
        ctx.beginPath();
        ctx.arc(n.x, n.y, 9, 0, Math.PI*2);
        ctx.fillStyle = favs.has(n.id) ? "#f59e0b" : "#111827";
        ctx.fill();

        // label
        ctx.font = "12px Arial";
        ctx.fillStyle = "#111827";
        const label = n.title.length > 26 ? n.title.slice(0,26) + "…" : n.title;
        ctx.fillText(label, n.x + 12, n.y + 4);
      });
    }

    let graphNodes = [];
    let graphEdges = [];

    function openGraph(){
      graph.classList.add('open');
      graph.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';

      graphNodes = buildNodes();
      graphEdges = buildEdges(graphNodes);
      drawGraph(graphNodes, graphEdges);
    }

    function closeGraph(){
      graph.classList.remove('open');
      graph.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    graphBtn.addEventListener('click', openGraph);
    graphClose.addEventListener('click', closeGraph);
    graph.addEventListener('click', (e)=>{ if(e.target === graph) closeGraph(); });

    // click node -> open viewer
    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // detect nearest node
      let hit = null;
      for(const n of graphNodes){
        const dx = n.x - x;
        const dy = n.y - y;
        if(dx*dx + dy*dy <= 11*11){ hit = n; break; }
      }
      if(hit && hit.href){
        closeGraph();
        openViewer(hit.href, hit.title);
      }
    });

    window.addEventListener('resize', ()=>{
      if(graph.classList.contains('open')){
        drawGraph(graphNodes, graphEdges);
      }
    });

    // init
    syncFavUI();
    renderActiveTags();
    setLang("he");
    apply();
  </script>

</body>
</html>
