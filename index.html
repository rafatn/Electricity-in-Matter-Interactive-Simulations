<!doctype html>
<html lang="he" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INDEX â€¢ ×“×£ ×”×‘×™×ª</title>
  <meta name="color-scheme" content="light dark">

  <style>
    :root{
      --bg0:#f4f6fb;
      --bg1:#eef2ff;
      --bg2:#ecfeff;

      --card:rgba(255,255,255,.78);
      --card2:rgba(255,255,255,.60);
      --cardSolid:#ffffff;

      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(148,163,184,.35);

      --head:#0b1220;
      --link:#2563eb;

      --shadow: 0 18px 50px rgba(2,6,23,.10);
      --shadow2: 0 10px 28px rgba(2,6,23,.10);
      --r:18px;

      --accent:#6366f1;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --chip:#e2e8f0;
      --chipText:#0f172a;

      --focus: 0 0 0 4px rgba(99,102,241,.22);
    }

    html[data-theme="dark"]{
      --bg0:#0b1020;
      --bg1:#0b1226;
      --bg2:#071626;

      --card:rgba(17,24,39,.62);
      --card2:rgba(17,24,39,.45);
      --cardSolid:#0f172a;

      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(148,163,184,.18);

      --head:#ffffff;
      --link:#93c5fd;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);

      --chip:#111827;
      --chipText:#e5e7eb;

      --focus: 0 0 0 4px rgba(147,197,253,.18);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 85% -10%, var(--bg2), transparent 55%),
        radial-gradient(900px 600px at 10% 0%, var(--bg1), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg0));
      min-height:100vh;
    }

    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.60), rgba(255,255,255,.14));
      border-bottom:1px solid var(--line);
    }
    html[data-theme="dark"] header{
      background: linear-gradient(180deg, rgba(15,23,42,.60), rgba(15,23,42,.14));
    }

    .wrap{max-width:1240px; margin:0 auto; padding:18px 18px 34px}
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      user-select:none;
      min-width: 260px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #a5b4fc, #4f46e5);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(45deg, rgba(255,255,255,.65), transparent 60%);
      transform: rotate(18deg);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      color:var(--head);
      line-height:1.2;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .hero{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius: calc(var(--r) + 6px);
      background: linear-gradient(135deg, rgba(99,102,241,.14), rgba(59,130,246,.10), rgba(20,184,166,.08));
      box-shadow: var(--shadow2);
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .hero .hLeft{
      display:flex; flex-direction:column; gap:6px; min-width:240px;
    }
    .hero .hTitle{
      font-weight:800;
      color:var(--head);
      letter-spacing:.2px;
    }
    .hero .hSub{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width: 740px;
    }
    .hero .hPills{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(2,6,23,.06);
    }

    .search{
      min-width:min(520px, 90vw);
      display:flex; gap:10px; align-items:center;
    }
    .search input{
      width:100%;
      padding:10px 10px;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .search .k{
      font-size:12px; color:var(--muted);
      padding:4px 8px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(148,163,184,.12);
      white-space:nowrap;
    }

    button, .btn{
      cursor:pointer;
      border:none;
      background: transparent;
      color:var(--text);
      font:inherit;
    }

    .btnIcon{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(2,6,23,.06);
      transition: transform .12s ease, filter .12s ease;
    }
    .btnIcon:hover{ transform: translateY(-1px); filter:brightness(1.02); }
    .btnIcon:focus-visible{ outline:none; box-shadow: var(--focus); }

    .btnPrimary{
      padding:10px 14px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(79,70,229,.95));
      color:white;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.15);
      transition: transform .12s ease, filter .12s ease;
      font-weight:700;
    }
    .btnPrimary:hover{ filter:brightness(1.03); transform: translateY(-1px); }
    .btnPrimary:focus-visible{ outline:none; box-shadow: var(--focus); }

    .btnGhost{
      padding:10px 12px;
      border-radius:14px;
      background: var(--card);
      border:1px solid var(--line);
      transition: transform .12s ease, filter .12s ease;
      font-weight:700;
    }
    .btnGhost:hover{ transform: translateY(-1px); filter:brightness(1.02); }
    .btnGhost:focus-visible{ outline:none; box-shadow: var(--focus); }

    .select{
      padding:10px 12px;
      border-radius:14px;
      background: var(--card);
      border:1px solid var(--line);
      color:var(--text);
      box-shadow: 0 10px 30px rgba(2,6,23,.06);
      outline:none;
      font-weight:700;
    }
    .select:focus-visible{ box-shadow: var(--focus); }

    .stat{
      padding:10px 12px;
      border-radius:14px;
      background: var(--card2);
      border:1px solid var(--line);
      display:flex; gap:10px; align-items:center;
    }
    .dot{
      width:10px; height:10px; border-radius:999px; background:var(--ok);
      box-shadow: 0 0 0 4px rgba(34,197,94,.15);
    }
    .dot.blue{background:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .dot.amber{background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.15)}
    .dot.purple{background:var(--accent); box-shadow:0 0 0 4px rgba(99,102,241,.16)}
    .stat b{color:var(--head)}
    .stat small{color:var(--muted)}

    .filters{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      justify-content:space-between;
    }

    .chips{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      background: var(--chip);
      color: var(--chipText);
      border:1px solid var(--line);
      font-size:13px;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .chip:hover{ transform: translateY(-1px); filter:brightness(1.02); }
    .chip.active{
      background: rgba(99,102,241,.16);
      border-color: rgba(99,102,241,.45);
    }

    .activeFilter{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed var(--line);
      background: rgba(148,163,184,.08);
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    main{padding-top:16px}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }

    .grid.list .card{ grid-column: 1 / -1; }
    .grid.list .cardInner{
      display:flex; gap:14px; align-items:stretch;
    }
    .grid.list .cardTop{ flex: 1; }
    .grid.list .cardBottom{
      width: 260px;
      border-top:none;
      border-right:1px solid var(--line);
      background: transparent;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:stretch;
      gap:10px;
    }
    @media (max-width: 740px){
      .grid.list .cardInner{ flex-direction:column; }
      .grid.list .cardBottom{
        width:auto;
        border-right:none;
        border-top:1px solid var(--line);
        flex-direction:row;
        justify-content:space-between;
        align-items:center;
      }
    }

    .card{
      grid-column: span 4;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform: translateY(0);
      transition: transform .14s ease, filter .14s ease;
    }
    .card:hover{ transform: translateY(-2px); filter:brightness(1.01); }

    @media (max-width: 980px){ .card{grid-column: span 6;} }
    @media (max-width: 640px){
      .card{grid-column: span 12;}
      .search{min-width:100%}
    }

    .cardTop{
      padding:14px 14px 10px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(148,163,184,.16);
      border:1px solid var(--line);
      color:var(--muted);
      user-select:none;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .title{
      margin:10px 0 0;
      font-size:15px;
      line-height:1.25;
      color:var(--head);
    }
    .desc{
      margin:8px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
      min-height: 38px;
    }

    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .meta .m{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(148,163,184,.10);
    }

    .cardBottom{
      padding:12px 14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.10), transparent);
    }
    html[data-theme="dark"] .cardBottom{
      background: linear-gradient(180deg, rgba(15,23,42,.15), transparent);
    }

    .openBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(99,102,241,.14);
      border:1px solid rgba(99,102,241,.35);
      color: var(--head);
      font-weight:800;
      min-width: 110px;
    }
    .openBtn:hover{ filter:brightness(1.03); text-decoration:none; }

    .actions{
      display:flex; gap:8px; align-items:center;
    }

    .favBtn, .copyBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: var(--cardSolid);
      border:1px solid var(--line);
      color: var(--text);
      font-weight:800;
      white-space:nowrap;
      transition: transform .12s ease, filter .12s ease;
    }
    .favBtn:hover, .copyBtn:hover{ transform: translateY(-1px); filter:brightness(1.02); }
    .favBtn:focus-visible, .copyBtn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .favIcon{width:18px; height:18px; display:inline-block; transform: translateY(1px);}

    .toast{
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
      color: var(--head);
      font-weight: 700;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      max-width: calc(100vw - 36px);
    }
    .toast.show{ opacity: 1; transform: translateY(0); }

    .empty{
      padding:22px;
      border-radius: var(--r);
      border:1px dashed var(--line);
      background: rgba(148,163,184,.08);
      color: var(--muted);
      grid-column: 1 / -1;
      text-align:center;
    }
    .empty strong{ color: var(--head); }
    .empty .row{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }

    footer{
      margin-top:22px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:12px 0 20px;
    }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>×“×£ ×”×‘×™×ª â€¢ ××™× ×“×§×¡ ×§×‘×¦×™×</h1>
          <p>×—×™×¤×•×© â€¢ ××•×¢×“×¤×™× â€¢ ×§×˜×’×•×¨×™×•×ª â€¢ ××•× ×” ×›× ×™×¡×•×ª â€¢ ××•× ×” ×¦×¤×™×•×ª ×œ×›×œ ×¨×¢×™×•×Ÿ</p>
        </div>
      </div>

      <div class="controls">
        <div class="pill search" title="×—×™×¤×•×© ×œ×¤×™ ×©×/×ª×™××•×¨/×ª×’×™×•×ª">
          <span class="mono" style="opacity:.75">ğŸ”</span>
          <input id="q" type="search" placeholder="×—×¤×© ×¨×¢×™×•×Ÿ / ×§×•×‘×¥ / ×ª×’×™×ª..." autocomplete="off">
          <span class="k mono">Ctrl+K</span>
        </div>

        <button class="btnIcon" id="themeBtn" title="××¦×‘ ×‘×”×™×¨/×›×”×”">ğŸŒ“</button>
        <button class="btnIcon" id="viewBtn" title="×ª×¦×•×’×”: Grid/List">â–¦</button>
        <select id="sortSel" class="select" title="××™×•×Ÿ">
          <option value="az">××™×•×Ÿ: Aâ†’Z</option>
          <option value="fav">××•×¢×“×¤×™× ×§×•×“×</option>
          <option value="za">××™×•×Ÿ: Zâ†’A</option>
        </select>

        <button class="btnGhost" id="showFavBtn" title="×”×¦×’ ××•×¢×“×¤×™× ×‘×œ×‘×“">â­ ××•×¢×“×¤×™×</button>
        <button class="btnPrimary" id="resetBtn" title="××™×¤×•×¡ ××•×¢×“×¤×™×/××•× ×” ××§×•××™/×¦×¤×™×•×ª">××™×¤×•×¡</button>
      </div>
    </div>

    <div class="hero">
      <div class="hLeft">
        <div class="hTitle">×ª×™×§ ×¢×‘×•×“×•×ª â€” ×›×œ ×”×¨×¢×™×•× ×•×ª ×‘××§×•× ××—×“</div>
        <div class="hSub">
          ×—×¤×© ×œ×¤×™ ×©×/×ª×’×™×ª, ×¡× ×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”, ×©××•×¨ ××•×¢×“×¤×™×, ×•×¤×ª×— ×›×œ ×“×£ ×‘×œ×—×™×¦×” ××—×ª.
          ××•× ×” ×¦×¤×™×•×ª × ×©××¨ ××§×•××™×ª ×‘××—×©×‘ ×©×œ×š.
        </div>
      </div>
      <div class="hPills">
        <div class="stat"><span class="dot blue"></span><div><b id="totalCount">0</b> <small>×§×‘×¦×™×</small></div></div>
        <div class="stat"><span class="dot"></span><div><b id="favCount">0</b> <small>××•×¢×“×¤×™×</small></div></div>
        <div class="stat"><span class="dot amber"></span><div><b id="visitCount">0</b> <small>×›× ×™×¡×•×ª ×œ×“×£</small></div></div>
        <div class="stat"><span class="dot purple"></span><div><b id="fileViewsTotal">0</b> <small>×¦×¤×™×•×ª ×‘×§×‘×¦×™×</small></div></div>
      </div>
    </div>

    <div class="filters">
      <div class="chips" id="chips"></div>
      <div class="activeFilter" id="activeInfo">×¡×™× ×•×Ÿ: ×”×›×œ â€¢ ×—×™×¤×•×©: â€” â€¢ ×ª×¦×•×’×”: Grid</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
  <footer>
    ×˜×™×¤: ××¤×©×¨ ×œ×œ×—×•×¥ <span class="mono">Ctrl+K</span> ×›×“×™ ×œ×§×¤×•×¥ ×œ×—×™×¤×•×©.
  </footer>
</main>

<div class="toast" id="toast">×”×•×¢×ª×§!</div>

<script>
/**
 * INDEX.HTML â€” ×¢× ××•× ×” ×¦×¤×™×•×ª ×œ×›×œ ×§×•×‘×¥ (localStorage)
 */

const RAW_FILES = [
  "water_walking_shoes_sonar_pump.html",
  "water_gas_train_blue.html",
  "water_air_shoes_trilingual_flow.html",
  "usb_network_osi_ipv6_plus_hw_usecase.html",
  "thermosiphon_flow_calculator_he",
  "smart_water_powered_door_full_plus_fixed_he",
  "smart_paver_mesh_thermal_sensing_he",
  "smart_floor_pressure_to_energy_model_he",
  "self_charging_headphones_FULL_katex_diagrams_simulation_explained",
  "qfm_plutos_combined_with_applications",
  "qfm_plutos_combined",
  "qfm_full_development_with_examples",
  "qaxm_full_multilang_complete2",
  "plutos_visual_socket_patent_style",
  "plugos_visual_socket_proposal",
  "plant_gas_to_bio_oil_mvp_he",
  "pendulum_drone_with_photo",
  "pendulum_drone_ship_mountain_he_en_ar",
  "patent_smart_boarding_token_he",
  "patent_clean_air_square_zone_he",
  "Nobel_Physics_Submission_AnnaBelPeaks",
  "new 8",
  "metabolic_railway_model_he_v3",
  "metabolic_railway_model_he",
  "living_tooth_model_full",
  "international_economic_constitution_offline_full_fr_es_ru",
  "international_economic_constitution_all_languages",
  "international_constitution_graph_animation_and_proof_offline",
  "integrated_model_description",
  "ideal_wave_supersonic_aircraft",
  "ideal_wave_aircraft",
  "ideal_wave_air_road_vehicle",
  "HybirdDataSecurity",
  "human_wave_transport_advanced",
  "hospital_integrative_flow_model_clear_equations",
  "hospital_flow_equations_all_packages_mega",
  "hospital_curtain_model_full_offline",
  "gamma_drawers_full",
  "fingerprint_gesture_full_v_he",
  "energy_harvesting_touch_tiles_road",
  "electricity_models_plus_simulations_bilingual_toggle",
  "earth_glider_train_multilang",
  "ceiling_house_theory_step_by_step_GOLD_OFFLINE",
  "building_stability_system_energy_he",
  "blood_spectral_vector_model",
  "bivdn_multilang_full_mobile",
  "bio_magnet_therapy",
  "absolute_organ_value_multilang_full_v2",
  "absolute_organ_value_multilang_full"
];

function ensureHtml(name){
  const s = String(name || "").trim();
  if(!s) return "";
  if(/\.html?$/i.test(s)) return s;
  return s + ".html";
}

function niceTitleFromFile(file){
  let base = file.replace(/\.html?$/i,"");
  base = base.replace(/[_\-]+/g," ").replace(/\s+/g," ").trim();
  return base
    .split(" ")
    .map(w => w.length<=2 ? w.toUpperCase() : (w[0].toUpperCase()+w.slice(1)))
    .join(" ");
}

function tagsFromFile(file){
  const f = file.toLowerCase();
  const tags = new Set();

  if(f.includes("multilang") || f.includes("trilingual") || f.includes("bilingual") || f.includes("all_languages") || f.includes("fr_es_ru") || f.includes("he_en_ar")){
    tags.add("×¨×‘-×œ×©×•× ×™");
  }
  if(f.includes("_he")) tags.add("×¢×‘×¨×™×ª");
  if(f.includes("patent") || f.includes("submission")) tags.add("×¤×˜× ×˜/×”×’×©×”");

  if(f.includes("water") || f.includes("gas") || f.includes("train")) tags.add("×ª×—×‘×•×¨×”/××™×");
  if(f.includes("usb") || f.includes("ipv6") || f.includes("security") || f.includes("hybirddata")) tags.add("×¨×©×ª/××‘×˜×—×”");
  if(f.includes("qfm") || f.includes("qaxm") || f.includes("plutos") || f.includes("plugos")) tags.add("××•×ª×•×ª/××•×“×œ×™×");
  if(f.includes("hospital") || f.includes("bio") || f.includes("organ") || f.includes("blood") || f.includes("therapy") || f.includes("tooth")) tags.add("×‘×¨×™××•×ª/×‘×™×•×œ×•×’×™×”");
  if(f.includes("energy") || f.includes("electricity") || f.includes("harvesting") || f.includes("pressure") || f.includes("thermo") || f.includes("thermal") || f.includes("thermosiphon") || f.includes("floor") || f.includes("paver")) tags.add("×× ×¨×’×™×”/×ª×¨××•");
  if(f.includes("aircraft") || f.includes("supersonic") || f.includes("air_road") || f.includes("glider")) tags.add("×ª×¢×•×¤×”");
  if(f.includes("pendulum") || f.includes("drone")) tags.add("×¨×—×¤× ×™×/××›× ×™×§×”");
  if(f.includes("house") || f.includes("ceiling") || f.includes("building") || f.includes("stability")) tags.add("×‘× ×™×™×”/××‘× ×™×");
  if(f.includes("drawer") || f.includes("gesture") || f.includes("fingerprint") || f.includes("mobile")) tags.add("×××©×§/UX");

  if(tags.size === 0) tags.add("×›×œ×œ×™");
  return [...tags];
}

function descFromFile(file){
  const f = file.toLowerCase();
  if(f.includes("index")) return "×“×£ ×”×‘×™×ª ×”××¨×›×–×™.";
  if(f.includes("patent")) return "××¡××š ×‘×¡×’× ×•×Ÿ ×¤×˜× ×˜ ×¢× ×ª×™××•×¨/×ª×¨×©×™××™×.";
  if(f.includes("calculator")) return "××—×©×‘×•×Ÿ/×›×œ×™ ×—×™×©×•×‘ ××™× ×˜×¨××§×˜×™×‘×™.";
  if(f.includes("simulation")) return "××•×“×œ ×¢× ×¡×™××•×œ×¦×™×”/×”×“××™×•×ª ×•× ×•×¡×—××•×ª.";
  if(f.includes("hospital")) return "××•×“×œ/×—×‘×™×œ×” ×”×§×©×•×¨×” ×œ×‘×™×ª ×—×•×œ×™×, ×–×¨×™××” ××• ×–×™×”×•×.";
  if(f.includes("constitution")) return "××¡××š/××•×“×œ ×‘×ª×—×•× ×—×•×§×ª×™-×›×œ×›×œ×™ ×¢× ×’×¨×¤×™×/×× ×™××¦×™×”.";
  if(f.includes("qfm") || f.includes("qaxm")) return "××•×“×œ ××•×ª×•×ª/×¤×™×ª×•×— ×¢× ×“×•×’×××•×ª ×•×™×™×©×•××™×.";
  if(f.includes("water") && f.includes("shoes")) return "×“×’×/×”×¡×‘×¨ ×œ× ×¢×œ×™ ××™×/××•×•×™×¨ ×•×¨×›×™×‘×™×.";
  if(f.includes("train")) return "×“×’×/×¨×¢×™×•×Ÿ ×ª×—×‘×•×¨×ª×™ (×¨×›×‘×ª/××™×/×’×–).";
  if(f.includes("energy") || f.includes("harvesting")) return "×¨×¢×™×•×Ÿ ××’×™×¨×ª/×”×¤×§×ª ×× ×¨×’×™×” ×¢× ×”×¡×‘×¨×™×.";
  if(f.includes("building") || f.includes("house") || f.includes("stability")) return "××•×“×œ/×ª×™××•×¨×™×” ×‘×ª×—×•× ××‘× ×™×/×‘× ×™×™×”.";
  return "××¡××š ×¨×¢×™×•×Ÿ/××•×“×œ ××¢×•×¦×‘.";
}

const FILES = RAW_FILES.map(ensureHtml).filter(Boolean);
const PAGES = FILES.map(file => ({
  title: niceTitleFromFile(file),
  file,
  desc: descFromFile(file),
  tags: tagsFromFile(file)
}));

/** LocalStorage keys */
const LS_FAV = "index.favs.v3";
const LS_THEME = "index.theme.v3";
const LS_VISITS = "index.visits.v3";
const LS_VIEW = "index.view.v2";
const LS_SORT = "index.sort.v2";
const LS_FILEVIEWS = "index.fileviews.v1"; // { "file.html": number }

const $ = (s)=>document.querySelector(s);
const grid = $("#grid");
const q = $("#q");
const chipsEl = $("#chips");
const totalCountEl = $("#totalCount");
const favCountEl = $("#favCount");
const visitCountEl = $("#visitCount");
const fileViewsTotalEl = $("#fileViewsTotal");
const showFavBtn = $("#showFavBtn");
const sortSel = $("#sortSel");
const viewBtn = $("#viewBtn");
const activeInfo = $("#activeInfo");
const toast = $("#toast");

let showFavOnly = false;
let activeTag = "×”×›×œ";
let viewMode = localStorage.getItem(LS_VIEW) || "grid"; // grid | list

function loadFavs(){
  try{ return new Set(JSON.parse(localStorage.getItem(LS_FAV) || "[]")); }
  catch{ return new Set(); }
}
function saveFavs(set){ localStorage.setItem(LS_FAV, JSON.stringify([...set])); }

function incVisits(){
  const n = Number(localStorage.getItem(LS_VISITS) || "0") + 1;
  localStorage.setItem(LS_VISITS, String(n));
  return n;
}
function setTheme(next){
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem(LS_THEME, next);
}
function getTheme(){ return localStorage.getItem(LS_THEME) || "light"; }
function norm(s){ return (s||"").toString().toLowerCase().trim(); }

/** File views */
function loadFileViews(){
  try{
    const obj = JSON.parse(localStorage.getItem(LS_FILEVIEWS) || "{}");
    return (obj && typeof obj === "object") ? obj : {};
  }catch{
    return {};
  }
}
function saveFileViews(obj){
  localStorage.setItem(LS_FILEVIEWS, JSON.stringify(obj || {}));
}
function incFileView(file){
  const views = loadFileViews();
  views[file] = Number(views[file] || 0) + 1;
  saveFileViews(views);
  return views[file];
}
function getFileView(file){
  const views = loadFileViews();
  return Number(views[file] || 0);
}
function totalFileViews(){
  const views = loadFileViews();
  let sum = 0;
  for(const k in views){
    sum += Number(views[k] || 0);
  }
  return sum;
}

function computeTags(){
  const all = new Map();
  for(const p of PAGES){
    (p.tags||[]).forEach(t=>{
      const k = String(t||"").trim();
      if(!k) return;
      all.set(k, (all.get(k)||0)+1);
    });
  }
  return [...all.entries()].sort((a,b)=>b[1]-a[1]).map(([t])=>t);
}

function renderChips(){
  const tags = computeTags();
  const all = ["×”×›×œ", ...tags];
  chipsEl.innerHTML = "";
  for(const t of all){
    const b = document.createElement("button");
    b.className = "chip" + (t===activeTag ? " active":"");
    b.textContent = t;
    b.onclick = ()=>{
      activeTag = t;
      renderChips();
      render();
    };
    chipsEl.appendChild(b);
  }
}

function matches(page, query){
  if(!query) return true;
  const s = norm(query);
  const hay = [page.title, page.file, page.desc, (page.tags||[]).join(" ")].map(norm).join(" | ");
  return hay.includes(s);
}
function tagOK(page){
  if(activeTag==="×”×›×œ") return true;
  return (page.tags||[]).includes(activeTag);
}
function escapeHtml(str){
  return (str||"").toString().replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function getSort(){ return localStorage.getItem(LS_SORT) || "az"; }
function setSort(v){ localStorage.setItem(LS_SORT, v); }

function compareAZ(a,b){
  return (a.title || a.file).localeCompare((b.title || b.file), "en");
}

function sortPages(items, favs){
  const mode = getSort();
  const arr = [...items];

  if(mode==="fav"){
    arr.sort((a,b)=>{
      const af = favs.has(a.file) ? 0 : 1;
      const bf = favs.has(b.file) ? 0 : 1;
      if(af !== bf) return af - bf;
      return compareAZ(a,b);
    });
    return arr;
  }

  if(mode==="za"){
    arr.sort((a,b)=>-compareAZ(a,b));
    return arr;
  }

  arr.sort(compareAZ);
  return arr;
}

function showToast(msg){
  toast.textContent = msg || "×‘×•×¦×¢";
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 1200);
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("×”×§×™×©×•×¨ ×”×•×¢×ª×§ âœ…");
    return true;
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.select();
    try{
      document.execCommand("copy");
      showToast("×”×§×™×©×•×¨ ×”×•×¢×ª×§ âœ…");
      return true;
    }catch{
      showToast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");
      return false;
    }finally{
      document.body.removeChild(ta);
    }
  }
}

function renderActiveInfo(){
  const qq = q.value.trim();
  const viewLabel = (viewMode==="list") ? "List" : "Grid";
  const tagLabel = activeTag || "×”×›×œ";
  activeInfo.textContent = `×¡×™× ×•×Ÿ: ${tagLabel} â€¢ ×—×™×¤×•×©: ${qq ? qq : "â€”"} â€¢ ×ª×¦×•×’×”: ${viewLabel}`;
}

/** open with counting */
function openWithCount(file){
  incFileView(file);
  fileViewsTotalEl.textContent = String(totalFileViews());
  window.location.href = encodeURI(file);
}

function render(){
  const favs = loadFavs();
  const query = q.value;

  let items = PAGES
    .filter(p=>matches(p, query))
    .filter(p=>tagOK(p))
    .filter(p=>!showFavOnly || favs.has(p.file));

  items = sortPages(items, favs);

  totalCountEl.textContent = String(PAGES.length);
  favCountEl.textContent = String(favs.size);
  fileViewsTotalEl.textContent = String(totalFileViews());

  grid.classList.toggle("list", viewMode==="list");
  grid.innerHTML = "";
  renderActiveInfo();

  if(!PAGES.length){
    grid.innerHTML = `<div class="empty"><strong>××™×Ÿ ×§×‘×¦×™× ×‘×¨×©×™××”.</strong></div>`;
    return;
  }
  if(!items.length){
    grid.innerHTML = `
      <div class="empty">
        <strong>×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</strong>
        <div style="margin-top:6px;">× ×¡×” ×œ×”×¡×™×¨ ×—×™×¤×•×©/×ª×’×™×ª ××• ×œ×‘×˜×œ â€œ××•×¢×“×¤×™× ×‘×œ×‘×“â€.</div>
        <div class="row">
          <button class="btnGhost" id="clearFilters">× ×™×§×•×™ ×¡×™× ×•×Ÿ</button>
          <button class="btnPrimary" id="clearSearch">× ×™×§×•×™ ×—×™×¤×•×©</button>
        </div>
      </div>
    `;
    $("#clearFilters").onclick = ()=>{
      activeTag = "×”×›×œ";
      showFavOnly = false;
      showFavBtn.textContent = "â­ ××•×¢×“×¤×™×";
      renderChips();
      render();
    };
    $("#clearSearch").onclick = ()=>{
      q.value = "";
      render();
    };
    return;
  }

  for(const page of items){
    const isFav = favs.has(page.file);
    const tags = (page.tags||[]).slice(0,4);
    const more = (page.tags||[]).length - tags.length;
    const views = getFileView(page.file);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="cardInner">
        <div class="cardTop">
          <div style="flex:1; min-width:0">
            <div class="badge" title="${escapeHtml(page.file)}">${escapeHtml(page.file)}</div>
            <h3 class="title" title="${escapeHtml(page.title)}">${escapeHtml(page.title || page.file)}</h3>
            <p class="desc">${escapeHtml(page.desc || "×œ×œ× ×ª×™××•×¨")}</p>
            <div class="meta">
              ${tags.map(t=>`<span class="m">#${escapeHtml(t)}</span>`).join("")}
              ${more>0 ? `<span class="m">+${more} ×ª×’×™×•×ª</span>` : ""}
              <span class="m" title="××•× ×” ×¦×¤×™×•×ª ××§×•××™">ğŸ‘ ×¦×¤×™×•×ª: ${views}</span>
            </div>
          </div>
        </div>

        <div class="cardBottom">
          <a class="openBtn" href="${encodeURI(page.file)}" data-open="${escapeHtml(page.file)}" target="_self" rel="noopener">â–¶ ×¤×ª×™×—×”</a>

          <div class="actions">
            <button class="copyBtn" data-file="${escapeHtml(page.file)}" title="×”×¢×ª×§×ª ×§×™×©×•×¨">ğŸ”— ×”×¢×ª×§</button>

            <button class="favBtn" data-file="${escapeHtml(page.file)}" title="×”×•×¡×£/×”×¡×¨ ××•×¢×“×¤×™×">
              <span class="favIcon" aria-hidden="true">${isFav ? "â­" : "â˜†"}</span>
              <span>${isFav ? "×‘××•×¢×“×¤×™×" : "×”×•×¡×£"}</span>
            </button>
          </div>
        </div>
      </div>
    `;

    card.querySelector(".favBtn").onclick = ()=>{
      const favs2 = loadFavs();
      if(favs2.has(page.file)) favs2.delete(page.file);
      else favs2.add(page.file);
      saveFavs(favs2);
      render();
    };

    card.querySelector(".copyBtn").onclick = ()=>{
      const href = encodeURI(page.file);
      const url = new URL(href, window.location.href).href;
      copyText(url);
    };

    // count view on click
    card.querySelector(".openBtn").addEventListener("click", (e)=>{
      e.preventDefault();
      openWithCount(page.file);
    });

    grid.appendChild(card);
  }
}

function init(){
  visitCountEl.textContent = String(incVisits());
  fileViewsTotalEl.textContent = String(totalFileViews());
  setTheme(getTheme());

  grid.classList.toggle("list", viewMode==="list");
  viewBtn.textContent = (viewMode==="list") ? "â‰¡" : "â–¦";

  sortSel.value = getSort();
  sortSel.onchange = ()=>{
    setSort(sortSel.value);
    render();
  };

  $("#themeBtn").onclick = ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    setTheme(cur==="light" ? "dark" : "light");
  };

  viewBtn.onclick = ()=>{
    viewMode = (viewMode==="grid") ? "list" : "grid";
    localStorage.setItem(LS_VIEW, viewMode);
    viewBtn.textContent = (viewMode==="list") ? "â‰¡" : "â–¦";
    render();
  };

  showFavBtn.onclick = ()=>{
    showFavOnly = !showFavOnly;
    showFavBtn.textContent = showFavOnly ? "â­ ×›×œ ×”×§×‘×¦×™×" : "â­ ××•×¢×“×¤×™×";
    render();
  };

  $("#resetBtn").onclick = ()=>{
    localStorage.removeItem(LS_FAV);
    localStorage.removeItem(LS_VISITS);
    localStorage.removeItem(LS_VIEW);
    localStorage.removeItem(LS_SORT);
    localStorage.removeItem(LS_FILEVIEWS);

    visitCountEl.textContent = String(incVisits());
    fileViewsTotalEl.textContent = String(totalFileViews());

    showFavOnly = false;
    showFavBtn.textContent = "â­ ××•×¢×“×¤×™×";
    q.value = "";
    activeTag = "×”×›×œ";
    viewMode = "grid";
    viewBtn.textContent = "â–¦";
    sortSel.value = "az";
    setSort("az");

    renderChips();
    render();
    showToast("××™×¤×•×¡ ×‘×•×¦×¢ âœ…");
  };

  q.addEventListener("input", ()=>render());

  window.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
      e.preventDefault();
      q.focus();
      q.select();
    }
  });

  renderChips();
  render();
}
init();
</script>
</body>
</html>
