<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××××¨ ××§×“××™ ××™× ×˜×¨××§×˜×™×‘×™ â€¢ ×›×™××™×” ×§×•×”×¨× ×˜×™×ª ××•×œ ××¢×‘×¨ ×’×¨×¢×™× ×™</title>
  <meta name="color-scheme" content="light dark">

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --bg0:#f5f7ff;
      --bg1:#eef2ff;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.55);

      --text:#0f172a;
      --muted:#475569;
      --line: rgba(148,163,184,.35);

      --accent:#4f46e5;
      --accent2:#0891b2;
      --ok:#16a34a;
      --warn:#f59e0b;

      --shadow: 0 18px 50px rgba(2,6,23,.10);
      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg0:#0b1220;
        --bg1:#0b1b30;
        --card: rgba(17,24,39,.72);
        --card2: rgba(17,24,39,.55);

        --text:#e5e7eb;
        --muted:#b6c2d1;
        --line: rgba(148,163,184,.22);

        --shadow: 0 18px 60px rgba(0,0,0,.45);
      }
      .katex { color: var(--text); }
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 80% -10%, rgba(79,70,229,.25), transparent 60%),
        radial-gradient(900px 520px at 0% 10%, rgba(8,145,178,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    header{
      padding: 28px 18px 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(8,145,178,.85));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      color:white; font-weight:800; letter-spacing:.5px;
    }
    h1{
      font-size: clamp(18px, 2.2vw, 26px);
      margin:0;
      line-height: 1.2;
    }
    .subtitle{ margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    .controls{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--card2);
      box-shadow: 0 8px 24px rgba(2,6,23,.08);
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.12);
    }
    .btn{
      appearance:none; border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:hover{ border-color: rgba(79,70,229,.45); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,70,229,.18), rgba(8,145,178,.10));
      border-color: rgba(79,70,229,.35);
    }
    .hint{ font-size: 12px; color: var(--muted); margin: 12px 0 0; }

    main{
      max-width: 1200px;
      margin: 0 auto 50px;
      padding: 0 18px 24px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:flex-start; justify-content: space-between; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), transparent);
    }
    .card .hd h2{
      margin:0;
      font-size: 16px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .tag{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.10);
      white-space: nowrap;
    }
    .card .bd{ padding: 14px 16px 16px; }

    .section{
      margin: 0 0 14px;
      padding-bottom: 12px;
      border-bottom: 1px dashed rgba(148,163,184,.35);
    }
    .section:last-child{ border-bottom: none; padding-bottom: 0; }
    p{ margin: 10px 0; color: var(--text); line-height: 1.7; }
    ul{ margin: 8px 0 0; padding: 0 18px 0 0; color: var(--text); }
    li{ margin: 6px 0; line-height: 1.65; }

    .callout{
      border: 1px solid rgba(79,70,229,.25);
      background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(8,145,178,.08));
      padding: 12px 12px;
      border-radius: 14px;
      margin: 10px 0;
    }
    .mono{
      font-family: var(--mono);
      font-size: 12.5px;
      background: rgba(2,6,23,.06);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      overflow:auto;
      direction:ltr;
      text-align:left;
    }
    @media (prefers-color-scheme: dark){
      .mono{ background: rgba(0,0,0,.25); }
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap: wrap;
      margin: 6px 0 0;
    }
    .tab{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(79,70,229,.20), rgba(8,145,178,.10));
      border-color: rgba(79,70,229,.40);
    }

    /* Interactive widgets */
    .widget{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap: wrap;
    }
    .row label{
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      min-width: 170px;
    }
    input[type="range"]{ width: min(520px, 100%); }
    .val{
      font-family: var(--mono);
      font-size: 12.5px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.10);
    }
    canvas{
      width: 100%;
      height: 260px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
    }
    .legend{
      display:flex; gap:10px; flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      display:inline-block; margin-left:6px; vertical-align: middle;
    }
    .small{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.6;
    }

    /* Formal vs Intuition switch */
    .switchWrap{
      display:flex; gap:10px; align-items:center; flex-wrap: wrap;
      margin: 8px 0 10px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.10);
    }
    .switchWrap .title{
      font-weight: 900;
    }
    .seg{
      display:inline-flex;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
    }
    .seg button{
      border: none;
      background: transparent;
      color: var(--text);
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
    }
    .seg button.active{
      background: linear-gradient(135deg, rgba(79,70,229,.20), rgba(8,145,178,.10));
      border-right: 1px solid rgba(148,163,184,.25);
    }

    .modeBlock{ display:none; }
    .modeBlock.active{ display:block; }

    @media print{
      .controls, .hint, .tabs, .tab, .no-print { display:none !important; }
      body{ background:white; }
      .card{ box-shadow:none; background:white; }
      .switchWrap{ display:none !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">âˆ‘</div>
      <div>
        <h1>×›×™××™×” ×§×•×”×¨× ×˜×™×ª ××•×œ ××¢×‘×¨ ×’×¨×¢×™× ×™ â€” ××××¨ ××§×“××™ ××™× ×˜×¨××§×˜×™×‘×™</h1>
        <div class="subtitle">KaTeX + ×ª×¨×©×™××™ Canvas ×“×™× ××™×™× + ××•×“ â€œ×¤×•×¨××œ×™/××™× ×˜×•××™×˜×™×‘×™â€ + ×¡×™××•×œ×¦×™×™×ª ×¡×•×¤×¨×¤×•×–×™×¦×™×” \(\Psi\)</div>
      </div>
    </div>

    <div class="controls no-print">
      <span class="pill" title="××¦×‘ ×ª×¦×•×’×”">
        <span style="font-weight:900;">ğŸŒ“</span>
        <select id="themeSel" class="btn" style="padding:8px 10px;">
          <option value="auto">××•×˜×•××˜×™</option>
          <option value="light">×‘×”×™×¨</option>
          <option value="dark">×›×”×”</option>
        </select>
      </span>
      <button class="btn primary" id="btnPrint">ğŸ–¨ï¸ ×”×“×¤×¡ / PDF</button>
      <button class="btn" id="btnCopyCite">ğŸ“Œ ×¦×™×˜×•×˜ (BibTeX)</button>
    </div>
  </div>

  <div class="hint">
    ×‘×¦×“ ×©×××œ: ××××¨ ×¢× ×›×¤×ª×•×¨ ×©××—×œ×™×£ ×‘×™×Ÿ <strong>××•×“×œ ×¤×•×¨××œ×™</strong> ×œÖ¾<strong>××™× ×˜×•××™×¦×™×” ×¤×™×–×™×§×œ×™×ª</strong>.
    ×‘×¦×“ ×™××™×Ÿ: ×ª×¨×©×™××™× ×“×™× ××™×™× + ×¡×™××•×œ×¦×™×” ×©×œ ×¡×•×¤×¨×¤×•×–×™×¦×™×” \(\Psi\) ×¢× ×¤××–×” \(\phi\) (××™× ×˜×¨×¤×¨× ×¦×™×” ×§×•×”×¨× ×˜×™×ª).
  </div>
</header>

<main class="grid">
  <!-- Left: Paper -->
  <section class="card" id="paper">
    <div class="hd">
      <h2>ğŸ“„ ×”××××¨</h2>
      <span class="tag">×’×¨×¡×” 1.1 â€¢ ×“×¦××‘×¨ 2025</span>
    </div>

    <div class="bd">
      <!-- Formal vs intuitive switch -->
      <div class="switchWrap no-print" aria-label="×”×—×œ×¤×ª ×ª×¦×•×’×”">
        <span class="title">×ª×¦×•×’×”:</span>
        <div class="seg" role="tablist" aria-label="××¦×‘ ×ª×¦×•×’×”">
          <button id="btnFormal" class="active" role="tab" aria-selected="true">××•×“×œ ×¤×•×¨××œ×™</button>
          <button id="btnIntuit" role="tab" aria-selected="false">××™× ×˜×•××™×¦×™×” ×¤×™×–×™×§×œ×™×ª</button>
        </div>
        <span class="small">××¤×©×¨ ×œ×”×—×œ×™×£ ×‘×›×œ ×¨×’×¢â€”×”× ×•×¡×—××•×ª × ×©××¨×•×ª, ×¨×§ ×”×”×¡×‘×¨ ××©×ª× ×”.</span>
      </div>

      <!-- FORMAL MODE -->
      <div id="formalBlock" class="modeBlock active">
        <div class="section">
          <h3 style="margin:0 0 6px;">×ª×§×¦×™×¨</h3>
          <p>
            ×× ×• ××¦×™×’×™× × ×™×¡×•×— ×ª××•×¨×˜×™ ×œ<strong>×—×•×§ ×©××™×¨×ª ×”×§×©×¨ ×”×›×™××™ ×”×§×•×”×¨× ×˜×™</strong> ×”××‘×—×™×Ÿ ×‘×™×Ÿ ×“×™× ××™×§×” ××œ×§×˜×¨×•× ×™×ª (×›×™××™×ª)
            ×œ×‘×™×Ÿ ×©×™× ×•×™ ×‘×”×¨×›×‘ ×’×¨×¢×™× ×™ (××¢×‘×¨ ×’×¨×¢×™× ×™). ×¢×¨×‘×•×‘ ×™×¡×•×“×•×ª ×™×›×•×œ ×œ×™×¦×•×¨ ××¦×‘×™× ××œ×§×˜×¨×•× ×™×™× ×§×•×œ×§×˜×™×‘×™×™× ×¦×¤×•×¤×™-×¨××•×ª
            ×‘×¢×œ×™ ×ª×›×•× ×•×ª â€œ×›×‘×“×•×ªâ€ (×‘×œ×™×¢×”/×¤×œ×™×˜×”/×”×¨×—×‘×ª ×¡×¤×§×˜×¨×•×), ××š ××™× ×• ××©× ×” ××ª ×–×”×•×ª ×”×’×¨×¢×™×Ÿ.
            ×”×”×‘×—× ×” ××ª×‘×˜××ª ×’× ×‘×¡×•×œ× ×”×× ×¨×’×™×”: <span class="mono">eV</span> ×‘×›×™××™×” ××•×œ <span class="mono">MeV</span> ×‘×’×¨×¢×™×Ÿ.
          </p>
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px;">×ª×–×” ×¤×•×¨××œ×™×ª</div>
            <div class="small">
              ×›×™××™×” ××©× ×” ××ª <em>×¤×•× ×§×¦×™×™×ª ×”×’×œ ×”××œ×§×˜×¨×•× ×™×ª</em> ×•××ª <em>×× ×¨×’×™×™×ª ×”×§×©×¨</em>,
              ××š ×œ× ××ª <em>\(Z,N\)</em> ×©×œ ×”×’×¨×¢×™×Ÿ. ×œ×›×Ÿ ×“××™×•×Ÿ ×¡×¤×§×˜×¨×œ×™ ××™× ×• ×©×§×•×œ ×œ×–×”×•×ª ×’×¨×¢×™× ×™×ª.
            </div>
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">1. ×”×’×“×¨×•×ª</h3>
          <p><strong>×›×™××™×” ×§×•×”×¨× ×˜×™×ª</strong> (×ª×™××•×¨ ×¢×™×•× ×™): ×¡×•×¤×¨×¤×•×–×™×¦×™×” ×§×•×œ×§×˜×™×‘×™×ª ×¢× ×¤××–×” ×™×—×¡×™×ª:</p>
          <div class="katex-block">
            \[
              \Psi_{\mathrm{chem}}(\mathbf{r},t)=\sum_i c_i\,\psi_i(\mathbf{r})\,e^{-i\omega_i t}
            \]
          </div>
          <p><strong>××¢×¨×›×ª ×’×¨×¢×™× ×™×ª</strong>:</p>
          <div class="katex-block">
            \[
              \Psi_{\mathrm{nuc}}=\Psi_{\mathrm{nuc}}(Z,N;\mathbf{R})
            \]
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">2. ×—×•×§ ×©××™×¨×ª ×”×§×©×¨ ×”×›×™××™ ×”×§×•×”×¨× ×˜×™</h3>
          <ul>
            <li><strong>×©×™××•×¨ ×–×”×•×ª ×’×¨×¢×™× ×™×ª:</strong> \(\sum Z_i\) ×•-\(\sum N_i\) × ×©××¨×™×.</li>
            <li><strong>××™× ×™××™×–×¦×™×” ×× ×¨×’×˜×™×ª:</strong> ×”××¢×¨×›×ª × ×•×˜×” ×œ×”×§×˜×™×Ÿ \(E_{\mathrm{bond}}\).</li>
            <li><strong>×§×•×¨×œ×¦×™×™×ª ×¤××–×”:</strong> ×™×ª×›×Ÿ \(\langle e^{i(\phi_i-\phi_j)}\rangle \neq 0\).</li>
          </ul>
          <div class="katex-block">
            \[
              \sum_i Z_i=\mathrm{const},\qquad \sum_i N_i=\mathrm{const}
            \]
            \[
              \frac{dE_{\mathrm{bond}}}{dt}\le 0
            \]
            \[
              \left\langle e^{i(\phi_i-\phi_j)} \right\rangle \neq 0
            \]
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">3. ×¦×¤×™×¤×•×ª ×¨××•×ª ×•×¡×¤×§×˜×¨×•×</h3>
          <div class="katex-block">
            \[
              g(E)=\sum_{n}\delta(E-E_n),\qquad
              \Delta E_{\mathrm{nuc}} \gg \Delta E_{\mathrm{chem}}
            \]
          </div>
          <p>
            \(g(E)\) ×¦×¤×•×¤×” ×¢×©×•×™×” ×œ×”×¨×—×™×‘ ×§×•×•×™× ×•×œ×™×¦×•×¨ ×‘×œ×™×¢×”/×¤×œ×™×˜×” â€œ×›×‘×“×”â€. ××•×œ× ×–×”×• ××¤×§×˜ ××œ×§×˜×¨×•× ×™.
          </p>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">4. ×”×©×•×•××” ××¡×›××ª</h3>
          <div class="mono" style="direction:rtl; text-align:right;">
×›×™××™×” ×§×•×”×¨× ×˜×™×ª:   ××œ×§×˜×¨×•× ×™× | ~eV | Z × ×©××¨ | ×¡×¤×§×˜×¨×•× ×¦×¤×•×£/×¨×—×‘
××¢×‘×¨ ×’×¨×¢×™× ×™:      (Z,N)      | ~MeV | Z ×™×›×•×œ ×œ×”×©×ª× ×•×ª | ×¡×¤×§×˜×¨×•× ×‘×“×™×“
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">× ×¡×¤×—: × ×•×¡×—××•×ª ××¤×ª×—</h3>
          <div class="katex-block">
            \[
            \Psi_{\mathrm{chem}}=\sum_i c_i\psi_i,\quad
            g(E)=\sum_n \delta(E-E_n),\quad
            \sum Z_i=\mathrm{const},\quad
            \Delta E_{\mathrm{nuc}}\gg \Delta E_{\mathrm{chem}}
            \]
          </div>
        </div>
      </div>

      <!-- INTUITIVE MODE -->
      <div id="intuitBlock" class="modeBlock">
        <div class="section">
          <h3 style="margin:0 0 6px;">××” ×”×¨×¢×™×•×Ÿ ×‘××™× ×˜×•××™×¦×™×”?</h3>
          <p>
            ×“××™×™×Ÿ ×©×™×© ×œ×š â€œ×ª×–××•×¨×ªâ€ ×©×œ ××œ×§×˜×¨×•× ×™×. ×›×©××¢×¨×‘×‘×™× ×—×•××¨×™×, ×× ×—× ×• ××—×œ×™×¤×™× ××ª <strong>×”×”×¨××•× ×™×”</strong>
            (××™×š ×”××œ×§×˜×¨×•× ×™× â€œ××ª×™×™×©×‘×™×â€ ×‘×™×Ÿ ××˜×•××™×) â€” ××‘×œ <strong>×œ× ××—×œ×™×¤×™× ××ª ×”×›×œ×™× ×¢×¦××</strong>
            (×”×’×¨×¢×™× ×™×).
          </p>
          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px;">××©×¤×˜ ××¤×ª×—</div>
            <div class="small">
              ×‘×›×™××™×” ××¤×©×¨ ×œ×©× ×•×ª <em>××™×š</em> ×”×—×•××¨ ××ª× ×”×’, ×œ×¤×¢××™× ××¤×™×œ×• â€œ×›××• ×—×•××¨ ×›×‘×“â€,
              ××‘×œ ××™Ö¾××¤×©×¨ ×œ×©× ×•×ª <em>××™</em> ×”×•× ×”×’×¨×¢×™×Ÿ (×›×œ ×¢×•×“ ×–×” ×ª×”×œ×™×š ×›×™××™).
            </div>
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">×œ××” ×–×” × ×¨××” ×œ×¤×¢××™× â€œ×›××• ×™×¡×•×“ ×›×‘×“â€?</h3>
          <ul>
            <li>×™×© ×”×¨×‘×” â€œ×¨××•×ªâ€ ××œ×§×˜×¨×•× ×™×•×ª ×§×¨×•×‘×•×ª â†’ ×”×‘×œ×™×¢×” × ×”×™×™×ª ×¨×—×‘×”.</li>
            <li>×™×© ××™× ×˜×¨××§×¦×™×•×ª ×¨×‘×•×ª â†’ ×”×§×•×•×™× â€œ× ××¨×—×™×â€.</li>
            <li>××§×‘×œ×™× ×—×ª×™××” ×¡×¤×§×˜×¨×œ×™×ª ×¢×©×™×¨×” â†’ ×“×•××” ×‘××‘×˜ ×¨××©×•×Ÿ ×œ×—×•××¨×™× ××¡×•×™××™×.</li>
          </ul>
          <p class="small">
            ××ª××˜×™×ª ×–×” ×§×©×•×¨ ×œ-\(g(E)\) ×•×œ×›×š ×©×¨××•×ª \(E_n\) × ×”×™×•×ª ×¦×¤×•×¤×•×ª:
          </p>
          <div class="katex-block">
            \[
              g(E)=\sum_{n}\delta(E-E_n)
            \]
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">×”×§×• ×”××“×•×: eV ××•×œ MeV</h3>
          <p>
            ×‘×›×™××™×” ××©×—×§×™× ×‘×× ×¨×’×™×•×ª ×©×œ ×§×©×¨×™× ××œ×§×˜×¨×•× ×™×™× (×‘×¢×¨×š eV).
            ×›×“×™ ×œ×©× ×•×ª ×’×¨×¢×™×Ÿ ×¦×¨×™×š â€œ×œ×’×¢×ªâ€ ×‘×¡×§××œ×” ××—×¨×ª ×œ×’××¨×™ (×‘×¢×¨×š MeV).
          </p>
          <div class="katex-block">
            \[
              \Delta E_{\mathrm{nuc}} \gg \Delta E_{\mathrm{chem}}
            \]
          </div>
          <p class="small">
            ×œ×›×Ÿ, ×× ××ª×” ×¨×•××” â€œ×ª×•×¤×¢×” ×—×–×§×”â€ ×‘×¡×¤×§×˜×¨×•× â€” ×–×” ×œ× ×‘×”×›×¨×— ××•××¨ â€œ×ª×”×œ×™×š ×’×¨×¢×™× ×™â€.
            ×”×¨×‘×” ×¤×¢××™× ×–×• ×¤×©×•×˜ ×›×™××™×” ××•×¨×›×‘×ª ×××•×“.
          </p>
        </div>

        <div class="section">
          <h3 style="margin:0 0 6px;">××” ×¤×™×¨×•×© â€œ×§×•×”×¨× ×˜×™×•×ªâ€ ×›××Ÿ?</h3>
          <p>
            ×§×•×”×¨× ×˜×™×•×ª ×¤×™×¨×•×©×” ×©×”×¤××–×•×ª ×©×œ ×—×œ×§×™× ×©×•× ×™× ×‘××¢×¨×›×ª â€œ××¡×•× ×›×¨× ×•×ªâ€ ×—×œ×§×™×ª.
            ×‘×¡×™××•×œ×¦×™×” ×‘×¦×“ ×™××™×Ÿ ×ª×¨××” ××™×š ×©×™× ×•×™ \(\phi\) ××©× ×” ××ª ×”××™× ×˜×¨×¤×¨× ×¦×™×” (×—×™×–×•×§/×‘×™×˜×•×œ).
          </p>
          <div class="katex-block">
            \[
              \Psi = c_1 e^{i\phi_1}\psi_1 + c_2 e^{i\phi_2}\psi_2,\quad
              \Delta\phi=\phi_2-\phi_1
            \]
          </div>
        </div>
      </div>

      <details class="no-print" style="margin-top:10px;">
        <summary style="cursor:pointer; font-weight:900;">BibTeX ×œ×¦×™×˜×•×˜ (×œ×—×¥ ×œ×”×¨×—×‘×”)</summary>
        <pre class="mono" id="bibtex">
@article{CoherentChemicalBondConservation2025,
  title   = {Coherent Chemical Bond Conservation: A Formal Comparison Between Coherent Chemistry and Nuclear Transitions (Interactive Note)},
  author  = {Anonymous},
  year    = {2025},
  month   = {12},
  note    = {Theoretical interactive HTML note (KaTeX + dynamic diagrams + phase superposition demo).}
}
        </pre>
      </details>
    </div>
  </section>

  <!-- Right: Interactive Panels -->
  <aside class="card">
    <div class="hd">
      <h2>ğŸ§ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª</h2>
      <span class="tag">×ª×¨×©×™××™× + \(\Psi\)</span>
    </div>

    <div class="bd">
      <div class="tabs no-print" role="tablist" aria-label="×œ×©×•× ×™×•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª">
        <button class="tab" role="tab" aria-selected="true" data-tab="tab-energy">×¡×•×œ× ×× ×¨×’×™×”</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="tab-dos">×¦×¤×™×¤×•×ª ×¨××•×ª \(g(E)\)</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="tab-spectrum">×¡×¤×§×˜×¨×•×</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="tab-psi">×¡×•×¤×¨×¤×•×–×™×¦×™×” \(\Psi\)</button>
      </div>

      <!-- Tab: Energy scale -->
      <section id="tab-energy" class="tabPanel">
        <p class="small">
          ××©×—×§×™× ×¢× ×™×—×¡ ×¡×•×œ× ×”×× ×¨×’×™×”: <strong>×›×™××™×” (eV)</strong> ××•×œ <strong>×’×¨×¢×™×Ÿ (MeV)</strong>.
          ×§×• ××§×•×•×§×• ××¦×™×™×Ÿ â€œ××–×•×¨ ××¢×‘×¨â€ ×¡×›××˜×™ (×”××—×©×” ×‘×œ×‘×“).
        </p>

        <div class="widget">
          <div class="row">
            <label for="chemEv">×›×™××™×”: \(\Delta E_{\mathrm{chem}}\) [eV]</label>
            <input id="chemEv" type="range" min="0.05" max="20" value="2.0" step="0.05">
            <span class="val" id="chemEvVal"></span>
          </div>
          <div class="row">
            <label for="nucMev">×’×¨×¢×™×Ÿ: \(\Delta E_{\mathrm{nuc}}\) [MeV]</label>
            <input id="nucMev" type="range" min="0.05" max="20" value="3.0" step="0.05">
            <span class="val" id="nucMevVal"></span>
          </div>

          <canvas id="cEnergy" width="900" height="320" aria-label="×ª×¨×©×™× ×¡×•×œ× ×× ×¨×’×™×”"></canvas>

          <div class="legend">
            <span><span class="dot" style="background: rgba(79,70,229,.9)"></span>×›×™××™×” (eV)</span>
            <span><span class="dot" style="background: rgba(8,145,178,.9)"></span>×’×¨×¢×™×Ÿ (MeV â†’ eV)</span>
            <span><span class="dot" style="background: rgba(245,158,11,.95)"></span>××–×•×¨ ××¢×‘×¨ (××–×”×¨×”)</span>
          </div>
        </div>
      </section>

      <!-- Tab: DOS -->
      <section id="tab-dos" class="tabPanel" style="display:none;">
        <p class="small">
          ×”×“×’××” ×¢×§×¨×•× ×™×ª ×œ×¦×¤×™×¤×•×ª ×¨××•×ª \(g(E)\): ×”×¨×‘×” ×¨××•×ª + ×¨×•×—×‘ ×§×• ×’×“×•×œ â‡’ â€œ×¢× ×Ÿâ€ ×¡×¤×§×˜×¨×œ×™ ×¨×—×‘.
        </p>

        <div class="widget">
          <div class="row">
            <label for="levelsN">××¡×¤×¨ ×¨××•×ª \(N\)</label>
            <input id="levelsN" type="range" min="6" max="140" value="50" step="1">
            <span class="val" id="levelsNVal"></span>
          </div>
          <div class="row">
            <label for="widthW">×¨×•×—×‘ ×§×• \(w\)</label>
            <input id="widthW" type="range" min="0.5" max="30" value="8" step="0.5">
            <span class="val" id="widthWVal"></span>
          </div>
          <div class="row">
            <label for="spreadS">×¤×™×–×•×¨ ×¨××•×ª</label>
            <input id="spreadS" type="range" min="10" max="120" value="45" step="1">
            <span class="val" id="spreadSVal"></span>
          </div>

          <canvas id="cDOS" width="900" height="320" aria-label="×ª×¨×©×™× ×¦×¤×™×¤×•×ª ×¨××•×ª"></canvas>

          <div class="small">
            ×§×™×¨×•×‘: ×‘××§×•× \(\delta\) ××©×ª××©×™× ×‘×¡×›×•× ×’××•×¡×™× ×›×“×™ ×œ×“××•×ª ×”×¨×—×‘×ª ×§×•×•×™×.
          </div>
        </div>
      </section>

      <!-- Tab: Spectrum comparison -->
      <section id="tab-spectrum" class="tabPanel" style="display:none;">
        <p class="small">
          ×”×©×•×•××ª ×¦×•×¨×” ×¡×›××˜×™×ª: ×›×™××™ (×¨×‘Ö¾×§×•×•×™× ×¨×—×‘×™×) ××•×œ ×’×¨×¢×™× ×™ (××¢×˜ ×§×•×•×™× ×‘×“×™×“×™×).
        </p>

        <div class="widget">
          <div class="row">
            <label for="chemBroad">×›×™××™×”: ×¨×•×—×‘ ×§×•</label>
            <input id="chemBroad" type="range" min="2" max="40" value="14" step="1">
            <span class="val" id="chemBroadVal"></span>
          </div>
          <div class="row">
            <label for="nucLines">×’×¨×¢×™×Ÿ: ××¡×¤×¨ ×§×•×•×™×</label>
            <input id="nucLines" type="range" min="2" max="18" value="6" step="1">
            <span class="val" id="nucLinesVal"></span>
          </div>

          <canvas id="cSpec" width="900" height="320" aria-label="×”×©×•×•××ª ×¡×¤×§×˜×¨×•×"></canvas>

          <div class="callout">
            <div style="font-weight:900; margin-bottom:6px;">××–×”×¨×ª ×¤×™×¨×•×©</div>
            <div class="small">
              ×–×”×• ××™×•×¨ ×¢×§×¨×•× ×™ ×‘×œ×‘×“. ×“××™×•×Ÿ ×•×™×–×•××œ×™ ×‘×¡×¤×§×˜×¨×•× ×œ× ××¡×¤×™×§ ×›×“×™ ×œ×”×¡×™×§ â€œ×’×¨×¢×™× ×™â€.
            </div>
          </div>
        </div>
      </section>

      <!-- Tab: Psi superposition -->
      <section id="tab-psi" class="tabPanel" style="display:none;">
        <p class="small">
          ×¡×™××•×œ×¦×™×” ×¢×§×¨×•× ×™×ª ×©×œ ×¡×•×¤×¨×¤×•×–×™×¦×™×”:
          \[
            \Psi = c_1 e^{i\phi_1}\psi_1 + c_2 e^{i\phi_2}\psi_2,\quad \Delta\phi=\phi_2-\phi_1
          \]
          ×”×ª×¨×©×™× ××¦×™×’ â€œ××™× ×˜×¨×¤×¨× ×¦×™×”â€ ×œ××•×¨×š ×¦×™×¨ \(x\) (×”××—×©×”: ×©×ª×™ ×¤×•× ×§×¦×™×•×ª ×‘×¡×™×¡ ×©×•× ×•×ª).
        </p>

        <div class="widget">
          <div class="row">
            <label for="c1">××©×¨×¢×ª \(c_1\)</label>
            <input id="c1" type="range" min="0" max="1" value="0.75" step="0.01">
            <span class="val" id="c1Val"></span>
          </div>
          <div class="row">
            <label for="c2">××©×¨×¢×ª \(c_2\)</label>
            <input id="c2" type="range" min="0" max="1" value="0.65" step="0.01">
            <span class="val" id="c2Val"></span>
          </div>
          <div class="row">
            <label for="dphi">×¤××–×” \(\Delta\phi\) [rad]</label>
            <input id="dphi" type="range" min="-3.1416" max="3.1416" value="0.0" step="0.01">
            <span class="val" id="dphiVal"></span>
          </div>
          <div class="row">
            <label for="decoh">×“×”-×§×•×”×¨× ×˜×™×•×ª \(\eta\)</label>
            <input id="decoh" type="range" min="0" max="1" value="0.0" step="0.01">
            <span class="val" id="decohVal"></span>
          </div>

          <canvas id="cPsi" width="900" height="320" aria-label="×ª×¨×©×™× ×¡×•×¤×¨×¤×•×–×™×¦×™×” Psi"></canvas>

          <div class="small">
            \(\eta\in[0,1]\) ××“××” ××•×‘×“×Ÿ ×§×•×”×¨× ×˜×™×•×ª: ×”××™×‘×¨ ×”××™× ×˜×¨×¤×¨× ×˜×™ ××•×›×¤×œ ×‘-\((1-\eta)\).
          </div>
        </div>
      </section>

    </div>
  </aside>
</main>

<footer style="max-width:1200px;margin:0 auto 26px;padding:0 18px;">
  <div class="card" style="padding:14px 16px;">
    <div style="font-weight:900; margin-bottom:6px;">×”×¢×¨×ª ××¡×’×¨×ª (×¢×™×•× ×™ ×‘×œ×‘×“)</div>
    <div class="small">
      ×”××¡××š ××¦×™×’ ×”×‘×—× ×” ×ª×™××•×¨×˜×™×ª ×‘×™×Ÿ ×ª×”×œ×™×›×™× ×›×™××™×™× ×œ×‘×™×Ÿ ×ª×”×œ×™×›×™× ×’×¨×¢×™× ×™×™×, ×¢× ×ª×¨×©×™××™× ×¡×›××˜×™×™× ×œ×”××—×©×”.
      ×”×•× ××™× ×• ××“×¨×™×š × ×™×¡×•×™×™ ×•××™× ×• ××ª××¨ ×©×™×˜×•×ª ××¢×©×™×•×ª ×œ×©×™× ×•×™ ×’×¨×¢×™× ×™× ××• ×™×¦×™×¨×ª ×—×•××¨×™× ××¡×•×›× ×™×.
    </div>
  </div>
</footer>

<script>
/* ========= KaTeX render ========= */
window.addEventListener("DOMContentLoaded", () => {
  const renderAll = () => {
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "\\[", right: "\\]", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false}
      ],
      throwOnError: false
    });
  };
  setTimeout(renderAll, 50);
});

/* ========= Theme ========= */
function setTheme(mode){
  document.documentElement.dataset.theme = mode;
  document.documentElement.style.colorScheme = (mode === "auto") ? "light dark" : mode;
}
function getEffectiveDark(){
  const mode = document.documentElement.dataset.theme || "auto";
  if(mode === "dark") return true;
  if(mode === "light") return false;
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
}
const themeSel = document.getElementById("themeSel");
themeSel.addEventListener("change", () => { setTheme(themeSel.value); drawAll(); });
setTheme("auto");

/* ========= Header controls ========= */
document.getElementById("btnPrint").addEventListener("click", () => window.print());
document.getElementById("btnCopyCite").addEventListener("click", async () => {
  const bib = document.getElementById("bibtex")?.innerText?.trim() || "";
  try{
    await navigator.clipboard.writeText(bib);
    alert("×”×¦×™×˜×•×˜ ×”×•×¢×ª×§ ×œ×œ×•×— (Clipboard).");
  }catch(e){
    alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª. ××¤×©×¨ ×œ×¡××Ÿ ×™×“× ×™×ª ×•×œ×”×¢×ª×™×§.");
  }
});

/* ========= Formal / Intuition toggle ========= */
const btnFormal = document.getElementById("btnFormal");
const btnIntuit = document.getElementById("btnIntuit");
const formalBlock = document.getElementById("formalBlock");
const intuitBlock = document.getElementById("intuitBlock");

function setMode(mode){
  if(mode === "formal"){
    btnFormal.classList.add("active");
    btnIntuit.classList.remove("active");
    btnFormal.setAttribute("aria-selected","true");
    btnIntuit.setAttribute("aria-selected","false");
    formalBlock.classList.add("active");
    intuitBlock.classList.remove("active");
  }else{
    btnIntuit.classList.add("active");
    btnFormal.classList.remove("active");
    btnIntuit.setAttribute("aria-selected","true");
    btnFormal.setAttribute("aria-selected","false");
    intuitBlock.classList.add("active");
    formalBlock.classList.remove("active");
  }
}
btnFormal.addEventListener("click", () => setMode("formal"));
btnIntuit.addEventListener("click", () => setMode("intuit"));

/* ========= Tabs ========= */
const tabs = Array.from(document.querySelectorAll(".tab"));
const panels = Array.from(document.querySelectorAll(".tabPanel"));
tabs.forEach(btn=>{
  btn.addEventListener("click", () => {
    tabs.forEach(t=>t.setAttribute("aria-selected","false"));
    btn.setAttribute("aria-selected","true");
    const id = btn.dataset.tab;
    panels.forEach(p => p.style.display = (p.id === id) ? "" : "none");
    requestAnimationFrame(drawAll);
  });
});

/* ========= Small helpers ========= */
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
function fmt(x, unit){
  const s = (Math.round(x*100)/100).toString();
  return `${s} ${unit}`;
}
function clearCanvas(ctx){
  const W = ctx.canvas.width, H = ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
}
function drawGrid(ctx, x0, y0, w, h, nx=6, ny=4){
  const dark = getEffectiveDark();
  ctx.save();
  ctx.strokeStyle = dark ? "rgba(148,163,184,.18)" : "rgba(148,163,184,.25)";
  ctx.lineWidth = 1;
  for(let i=0;i<=nx;i++){
    const x = x0 + (w*i/nx);
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
  }
  for(let j=0;j<=ny;j++){
    const y = y0 + (h*j/ny);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
  }
  ctx.restore();
}
function text(ctx, s, x, y, opts={}){
  const dark = getEffectiveDark();
  ctx.save();
  ctx.fillStyle = opts.color || (dark ? "rgba(229,231,235,.92)" : "rgba(15,23,42,.92)");
  ctx.font = opts.font || "800 13px system-ui";
  ctx.textAlign = opts.align || "right";
  ctx.fillText(s, x, y);
  ctx.restore();
}
function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}
function labelChip(ctx, x, y, s, color){
  const padX=10, padY=6;
  const dark = getEffectiveDark();
  ctx.save();
  ctx.font = "900 12px system-ui";
  const w = ctx.measureText(s).width + padX*2;
  const h = 26;
  ctx.fillStyle = dark ? "rgba(17,24,39,.75)" : "rgba(255,255,255,.80)";
  ctx.strokeStyle = dark ? "rgba(148,163,184,.22)" : "rgba(148,163,184,.35)";
  ctx.lineWidth = 1;
  roundRect(ctx, x-w, y-h, w, h, 12);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = color;
  ctx.textAlign = "right";
  ctx.fillText(s, x-padX, y-8);
  ctx.restore();
}
function lerp(a,b,t){ return a + (b-a)*t; }
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

/* ========= Widget elements ========= */
const sChemEv = document.getElementById("chemEv");
const sNucMev = document.getElementById("nucMev");
const chemEvVal = document.getElementById("chemEvVal");
const nucMevVal = document.getElementById("nucMevVal");

const sLevelsN = document.getElementById("levelsN");
const sWidthW  = document.getElementById("widthW");
const sSpreadS = document.getElementById("spreadS");
const levelsNVal = document.getElementById("levelsNVal");
const widthWVal  = document.getElementById("widthWVal");
const spreadSVal = document.getElementById("spreadSVal");

const sChemBroad = document.getElementById("chemBroad");
const sNucLines  = document.getElementById("nucLines");
const chemBroadVal = document.getElementById("chemBroadVal");
const nucLinesVal  = document.getElementById("nucLinesVal");

/* Psi sliders */
const sC1 = document.getElementById("c1");
const sC2 = document.getElementById("c2");
const sDP = document.getElementById("dphi");
const sDe = document.getElementById("decoh");
const c1Val = document.getElementById("c1Val");
const c2Val = document.getElementById("c2Val");
const dphiVal = document.getElementById("dphiVal");
const decohVal = document.getElementById("decohVal");

function syncLabels(){
  chemEvVal.textContent = fmt(parseFloat(sChemEv.value), "eV");
  nucMevVal.textContent = fmt(parseFloat(sNucMev.value), "MeV");
  levelsNVal.textContent = `${parseInt(sLevelsN.value,10)}`;
  widthWVal.textContent  = `${parseFloat(sWidthW.value).toFixed(1)}`;
  spreadSVal.textContent = `${parseInt(sSpreadS.value,10)}`;
  chemBroadVal.textContent = `${parseInt(sChemBroad.value,10)}`;
  nucLinesVal.textContent  = `${parseInt(sNucLines.value,10)}`;

  c1Val.textContent = parseFloat(sC1.value).toFixed(2);
  c2Val.textContent = parseFloat(sC2.value).toFixed(2);
  dphiVal.textContent = parseFloat(sDP.value).toFixed(2);
  decohVal.textContent = parseFloat(sDe.value).toFixed(2);
}
[
  sChemEv,sNucMev,sLevelsN,sWidthW,sSpreadS,sChemBroad,sNucLines,
  sC1,sC2,sDP,sDe
].forEach(el=>{
  el.addEventListener("input", ()=>{ syncLabels(); drawAll(); });
});
syncLabels();

/* ========= Draw: Energy ========= */
function drawEnergy(){
  const canvas = document.getElementById("cEnergy");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  clearCanvas(ctx);

  const W = canvas.width, H = canvas.height;
  const pad = 34;
  const x0 = pad, y0 = pad+10, w = W-pad*2, h = H-pad*2-10;

  drawGrid(ctx, x0, y0, w, h, 8, 4);

  const colChem = "rgba(79,70,229,.92)";
  const colNuc  = "rgba(8,145,178,.92)";
  const colWarn = "rgba(245,158,11,.95)";

  const chemEv = parseFloat(sChemEv.value);
  const nucMev = parseFloat(sNucMev.value);
  const nucEv  = nucMev * 1e6;

  // Log-scale mapping: 1e-2..1e8 eV
  const minLog = Math.log10(1e-2);
  const maxLog = Math.log10(1e8);
  function xFromEv(ev){
    const t = (Math.log10(ev) - minLog) / (maxLog - minLog);
    return x0 + clamp(t,0,1)*w;
  }

  text(ctx, "×¡×•×œ× ×× ×¨×’×™×” (×œ×•×’10 eV)", x0+w, y0-10, {font:"900 13px system-ui"});

  // boundary (schematic)
  const boundaryEv = 1e4;
  const xb = xFromEv(boundaryEv);
  ctx.save();
  ctx.strokeStyle = colWarn;
  ctx.lineWidth = 2;
  ctx.setLineDash([8,6]);
  ctx.beginPath(); ctx.moveTo(xb, y0); ctx.lineTo(xb, y0+h); ctx.stroke();
  ctx.restore();
  labelChip(ctx, xb-10, y0+22, "××–×•×¨ ××¢×‘×¨ (×”××—×©×”)", colWarn);

  function marker(ev, color, label){
    const x = xFromEv(ev);
    const y = y0 + h*0.55;
    ctx.save();
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.arc(x, y, 9, 0, Math.PI*2); ctx.stroke();
    ctx.globalAlpha = 0.18;
    ctx.beginPath(); ctx.arc(x, y, 16, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
    labelChip(ctx, x+140, y-8, label, color);
  }

  marker(chemEv, colChem, `×›×™××™×”: Î”Eâ‰ˆ${chemEv.toFixed(2)} eV`);
  marker(nucEv,  colNuc,  `×’×¨×¢×™×Ÿ: Î”Eâ‰ˆ${nucMev.toFixed(2)} MeV (= ${nucEv.toExponential(2)} eV)`);

  const ratio = nucEv / chemEv;
  const ratioStr = ratio >= 1e6 ? ratio.toExponential(2) : ratio.toFixed(0);
  text(ctx, `×™×—×¡ ××•×¤×™×™× ×™:  Î”E_nuc / Î”E_chem â‰ˆ ${ratioStr}`, x0+w, y0+h-8, {font:"900 12px system-ui"});

  // x ticks
  ctx.save();
  ctx.fillStyle = getEffectiveDark() ? "rgba(182,194,209,.95)" : "rgba(71,85,105,.95)";
  ctx.font = "800 11px system-ui";
  ctx.textAlign = "center";
  [-2,0,2,4,6,8].forEach(p=>{
    const ev = Math.pow(10,p);
    const x = xFromEv(ev);
    ctx.fillText(`10^${p}`, x, y0+h+16);
  });
  ctx.restore();
}

/* ========= Draw: DOS ========= */
function gaussian(x, mu, sigma){
  const z = (x-mu)/sigma;
  return Math.exp(-0.5*z*z);
}
function drawDOS(){
  const canvas = document.getElementById("cDOS");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  clearCanvas(ctx);

  const W = canvas.width, H = canvas.height;
  const pad = 34;
  const x0 = pad, y0 = pad+10, w = W-pad*2, h = H-pad*2-10;

  drawGrid(ctx, x0, y0, w, h, 8, 4);

  const col = "rgba(79,70,229,.92)";
  const col2 = "rgba(8,145,178,.88)";

  const N = parseInt(sLevelsN.value,10);
  const width = parseFloat(sWidthW.value);
  const spread = parseInt(sSpreadS.value,10);

  const rng = mulberry32(123456 + N*7 + Math.floor(width*10) + spread*13);
  const levels = [];
  for(let i=0;i<N;i++){
    const u = (rng()*2 - 1);
    const v = (rng()*2 - 1);
    const e = (u + 0.35*v) * spread;
    levels.push(e);
  }
  levels.sort((a,b)=>a-b);

  const Emin = -200, Emax = 200;
  const M = 520;
  const xs = new Array(M);
  const g = new Array(M).fill(0);
  for(let k=0;k<M;k++){
    const E = lerp(Emin, Emax, k/(M-1));
    xs[k]=E;
    let sum=0;
    for(let i=0;i<levels.length;i++){
      sum += gaussian(E, levels[i], width);
    }
    g[k]=sum;
  }
  const gMax = Math.max(...g) || 1;

  function X(E){ return x0 + ( (E - Emin) / (Emax - Emin) ) * w; }
  function Y(val){ return y0 + h - (val / gMax) * (h*0.88); }

  ctx.save();
  ctx.strokeStyle = col;
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  for(let k=0;k<M;k++){
    const x = X(xs[k]);
    const y = Y(g[k]);
    if(k===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  ctx.save();
  ctx.strokeStyle = col2;
  ctx.globalAlpha = 0.35;
  ctx.lineWidth = 1;
  levels.slice(0, Math.min(levels.length, 120)).forEach(E=>{
    const x = X(E);
    ctx.beginPath();
    ctx.moveTo(x, y0+h);
    ctx.lineTo(x, y0+h-28);
    ctx.stroke();
  });
  ctx.restore();

  text(ctx, "×”×“×’××ª ×¦×¤×™×¤×•×ª ×¨××•×ª g(E) (×§×™×¨×•×‘ ×‘×××¦×¢×•×ª ×’××•×¡×™×)", x0+w, y0-10, {font:"900 13px system-ui"});
  text(ctx, `N=${N}  â€¢  wâ‰ˆ${width.toFixed(1)}  â€¢  spreadâ‰ˆ${spread}`, x0+w, y0+h-8, {font:"900 12px system-ui"});

  ctx.save();
  ctx.fillStyle = getEffectiveDark() ? "rgba(182,194,209,.95)" : "rgba(71,85,105,.95)";
  ctx.font = "800 11px system-ui";
  ctx.textAlign = "center";
  [-200,-100,0,100,200].forEach(E=>{
    ctx.fillText(`${E}`, X(E), y0+h+16);
  });
  ctx.restore();
}

/* ========= Draw: Spectrum ========= */
function drawSpectrum(){
  const canvas = document.getElementById("cSpec");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  clearCanvas(ctx);

  const W = canvas.width, H = canvas.height;
  const pad = 34;
  const x0 = pad, y0 = pad+10, w = W-pad*2, h = H-pad*2-10;

  drawGrid(ctx, x0, y0, w, h, 8, 4);

  const colChem = "rgba(79,70,229,.92)";
  const colNuc  = "rgba(8,145,178,.92)";

  const chemWidth = parseInt(sChemBroad.value,10);
  const nucCount = parseInt(sNucLines.value,10);

  const M=520;
  const xs = new Array(M);
  const chem = new Array(M).fill(0);

  const rng = mulberry32(2025 + chemWidth*31 + nucCount*17);
  const peaksN = 70;
  const peaks = [];
  for(let i=0;i<peaksN;i++){
    peaks.push({
      mu: rng(),
      a:  0.6 + rng()*0.9,
      s:  (chemWidth/220) * (0.5 + rng()*1.2)
    });
  }
  for(let k=0;k<M;k++){
    const x = k/(M-1);
    xs[k]=x;
    let sum=0;
    for(const p of peaks){
      const s = Math.max(0.002, p.s);
      const z = (x-p.mu)/s;
      sum += p.a*Math.exp(-0.5*z*z);
    }
    chem[k]=sum;
  }
  const chemMax = Math.max(...chem) || 1;

  const nucLines = [];
  for(let i=0;i<nucCount;i++){
    nucLines.push(0.08 + (0.84)*(i/(Math.max(1,nucCount-1))));
  }

  function X(u){ return x0 + u*w; }

  ctx.save();
  ctx.strokeStyle = colChem;
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  for(let k=0;k<M;k++){
    const x = X(xs[k]);
    const y = y0 + (h*0.52) - (chem[k]/chemMax)*(h*0.45);
    if(k===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  labelChip(ctx, x0+w, y0+26, "×›×™××™: ×§×•×•×™× ×¦×¤×•×¤×™×/×¨×—×‘×™× (×¢×§×¨×•× ×™)", colChem);

  ctx.save();
  ctx.strokeStyle = colNuc;
  ctx.lineWidth = 3;
  nucLines.forEach(u=>{
    const x = X(u);
    const yBottom = y0+h;
    const yTop = y0 + h*0.62;
    ctx.beginPath(); ctx.moveTo(x, yBottom); ctx.lineTo(x, yTop); ctx.stroke();
    ctx.beginPath(); ctx.arc(x, yTop, 4.5, 0, Math.PI*2);
    ctx.fillStyle = colNuc; ctx.fill();
  });
  ctx.restore();

  labelChip(ctx, x0+w, y0 + h*0.86, "×’×¨×¢×™× ×™: ×§×•×•×™× ×‘×“×™×“×™× (×¢×§×¨×•× ×™)", colNuc);

  text(ctx, "×”×©×•×•××ª ×¦×•×¨×”: ×¡×¤×§×˜×¨×•× ×›×™××™ ××•×œ ×’×¨×¢×™× ×™ (×”××—×©×” ×‘×œ×‘×“)", x0+w, y0-10, {font:"900 13px system-ui"});
  text(ctx, `×›×™××™×”: ×¨×•×—×‘â‰ˆ${chemWidth}  â€¢  ×’×¨×¢×™×Ÿ: ${nucCount} ×§×•×•×™×`, x0+w, y0+h-8, {font:"900 12px system-ui"});

  ctx.save();
  ctx.fillStyle = getEffectiveDark() ? "rgba(182,194,209,.95)" : "rgba(71,85,105,.95)";
  ctx.font = "800 11px system-ui";
  ctx.textAlign = "center";
  [0,0.25,0.5,0.75,1].forEach(u=>{
    ctx.fillText(u.toFixed(2), X(u), y0+h+16);
  });
  ctx.restore();
}

/* ========= Draw: Psi Superposition (Interference) =========
   Model:
     psi1(x) = cos(kx)
     psi2(x) = sin(2kx)
   Psi(x) = c1*psi1 + c2*e^{i dphi}*psi2
   Intensity I(x) = |Psi|^2
   Decoherence eta: cross term scaled by (1-eta).
*/
function drawPsi(){
  const canvas = document.getElementById("cPsi");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  clearCanvas(ctx);

  const W = canvas.width, H = canvas.height;
  const pad = 34;
  const x0 = pad, y0 = pad+10, w = W-pad*2, h = H-pad*2-10;

  drawGrid(ctx, x0, y0, w, h, 8, 4);

  const colI   = "rgba(79,70,229,.92)"; // intensity
  const colP1  = "rgba(8,145,178,.85)"; // psi1
  const colP2  = "rgba(245,158,11,.90)"; // psi2

  const c1 = parseFloat(sC1.value);
  const c2 = parseFloat(sC2.value);
  const dphi = parseFloat(sDP.value);
  const eta = parseFloat(sDe.value);
  const coh = (1 - eta);

  // define functions
  const k = 2*Math.PI; // one cycle over [0,1]
  const M = 520;
  const xs = new Array(M);
  const p1 = new Array(M);
  const p2 = new Array(M);
  const I  = new Array(M);

  // intensity computed analytically:
  // |c1 psi1 + c2 e^{i dphi} psi2|^2 = c1^2 psi1^2 + c2^2 psi2^2 + 2 c1 c2 psi1 psi2 cos(dphi)
  // decoherence: cross term scaled by coh
  for(let i=0;i<M;i++){
    const u = i/(M-1);
    xs[i]=u;
    const x = u;
    const psi1 = Math.cos(k*x);
    const psi2 = Math.sin(2*k*x);
    p1[i]=psi1;
    p2[i]=psi2;
    const intensity = (c1*c1*psi1*psi1) + (c2*c2*psi2*psi2) + (2*c1*c2*psi1*psi2*Math.cos(dphi)*coh);
    I[i]=intensity;
  }

  const Imax = Math.max(...I), Imin = Math.min(...I);
  const pMax = 1.0;

  function X(u){ return x0 + u*w; }
  function Ymid(v){ // for waveforms (centered)
    const mid = y0 + h*0.36;
    const amp = h*0.22;
    return mid - (v/pMax)*amp;
  }
  function YI(v){ // intensity in lower half
    const top = y0 + h*0.55;
    const ih = h*0.42;
    const t = (v - Imin) / Math.max(1e-9,(Imax - Imin));
    return top + ih - t*ih;
  }

  // psi1
  ctx.save();
  ctx.strokeStyle = colP1;
  ctx.globalAlpha = 0.85;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<M;i++){
    const x = X(xs[i]);
    const y = Ymid(p1[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // psi2
  ctx.save();
  ctx.strokeStyle = colP2;
  ctx.globalAlpha = 0.80;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<M;i++){
    const x = X(xs[i]);
    const y = Ymid(p2[i]) + h*0.18; // small offset for readability
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // Intensity
  ctx.save();
  ctx.strokeStyle = colI;
  ctx.lineWidth = 2.8;
  ctx.beginPath();
  for(let i=0;i<M;i++){
    const x = X(xs[i]);
    const y = YI(I[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // Titles
  text(ctx, "×¡×•×¤×¨×¤×•×–×™×¦×™×” ×•×”×¤×¨×¢×”: I(x)=|Î¨(x)|Â² (×”××—×©×” ×¢×§×¨×•× ×™×ª)", x0+w, y0-10, {font:"900 13px system-ui"});
  text(ctx, `c1=${c1.toFixed(2)} â€¢ c2=${c2.toFixed(2)} â€¢ Î”Ï†=${dphi.toFixed(2)} rad â€¢ Î·=${eta.toFixed(2)} (coh=${coh.toFixed(2)})`,
       x0+w, y0+h-8, {font:"900 12px system-ui"});

  // chips
  labelChip(ctx, x0+w, y0+28, "Ïˆ1(x)=cos(kx)", colP1);
  labelChip(ctx, x0+w, y0+58, "Ïˆ2(x)=sin(2kx)", colP2);
  labelChip(ctx, x0+w, y0+ h*0.74, "I(x)=|Î¨|Â² (×›×•×œ×œ ××™×‘×¨ ×”×¤×¨×¢×”)", colI);

  // X ticks
  ctx.save();
  ctx.fillStyle = getEffectiveDark() ? "rgba(182,194,209,.95)" : "rgba(71,85,105,.95)";
  ctx.font = "800 11px system-ui";
  ctx.textAlign = "center";
  [0,0.25,0.5,0.75,1].forEach(u=>{
    ctx.fillText(u.toFixed(2), X(u), y0+h+16);
  });
  ctx.restore();
}

/* ========= Draw all ========= */
function drawAll(){
  drawEnergy();
  drawDOS();
  drawSpectrum();
  drawPsi();
}
drawAll();
window.addEventListener("resize", ()=> requestAnimationFrame(drawAll));
window.matchMedia?.("(prefers-color-scheme: dark)")?.addEventListener?.("change", ()=> requestAnimationFrame(drawAll));
</script>
</body>
</html>
